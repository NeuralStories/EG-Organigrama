<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGEA Dev - Estudio Organizativo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #0079bf;
            --primary-hover: #026aa7;
            --primary-light: #a5d8ff;
            --secondary-color: #5e6c84;
            --danger-color: #de350b;
            --danger-light-bg: #ffebe6;
            --success-color: #4bbf6b;
            --success-light-bg: #f0f9f4;
            --warning-color: #d97706;
            --warning-light-bg: #fffbeb;
            --background-light: #f4f5f7;
            --background-white: #ffffff;
            --text-dark: #172b4d;
            --text-light: #5e6c84;
            --border-color: #dfe1e6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
        html, body { height: 100%; }
        body { display: flex; flex-direction: column; background-color: var(--background-light); min-height: 100vh; color: var(--text-dark); }
        #root { flex: 1 0 auto; }
        footer { flex-shrink: 0; text-align: center; padding: 20px; color: var(--text-light); font-size: 14px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--background-white); border-radius: 3px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 1px rgba(9,30,66,.25); }
        .header-title h1 { color: var(--text-dark); font-size: 24px; font-weight: 600; }
        .header-title p { color: var(--text-light); font-size: 14px; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .navigation { 
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; 
            padding-bottom: 10px; position: sticky; top: 0;
            background-color: var(--background-light); z-index: 10; padding-top: 10px; border-bottom: 1px solid var(--border-color);
        }
        .nav-btn { background: var(--background-white); border: none; padding: 10px 15px; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text-dark); transition: all 0.2s ease; box-shadow: 0 1px 0 rgba(9,30,66,.25); white-space: nowrap; }
        .nav-btn:hover { background-color: #ebecf0; }
        .nav-btn.active { background-color: #e4f0f6; color: var(--primary-color); box-shadow: inset 0 0 0 2px var(--primary-color); }
        .content-section { display: none; background: transparent; }
        .content-section.active { display: block; }
        .phase-header { background: var(--background-white); color: var(--text-dark); padding: 15px; border-radius: 3px; margin-bottom: 15px; box-shadow: 0 1px 1px rgba(9,30,66,.25); }
        .phase-header h2 { font-size: 18px; margin-bottom: 5px; font-weight: 600; }
        .phase-header p { font-size: 12px; color: var(--text-light); }
        .checklist { list-style: none; margin: 10px 0; }
        .checklist li { background: var(--background-white); margin: 5px 0; padding: 12px; border-radius: 3px; transition: all 0.3s ease; position: relative; box-shadow: 0 1px 0 rgba(9,30,66,.25); font-size: 14px; border-left: 4px solid transparent; }
        .checklist li.status-aprobado { background-color: var(--success-light-bg); border-left-color: var(--success-color); }
        .checklist li.status-aprobado .task-title { text-decoration: line-through; color: #9ca3af; }
        .checklist li.status-parado { background-color: var(--danger-light-bg); border-left-color: var(--danger-color); }
        .checklist li.status-pendiente { background-color: var(--warning-light-bg); border-left-color: var(--warning-color); }
        .task-title { flex-grow: 1; font-weight: 500; }
        .task-status-selector { display: flex; gap: 6px; align-items: center; }
        .status-btn { padding: 2px 8px; border-radius: 12px; font-size: 11px; cursor: pointer; border: 1px solid; transition: all 0.2s; font-weight: 500;}
        .status-btn.pendiente { background-color: transparent; color: var(--warning-color); border-color: var(--warning-color); }
        .status-btn.parado { background-color: transparent; color: var(--danger-color); border-color: var(--danger-color); }
        .status-btn.aprobado { background-color: transparent; color: var(--success-color); border-color: var(--success-color); }
        .status-btn.active { color: white; }
        .status-btn.active.pendiente { background-color: var(--warning-color); }
        .status-btn.active.parado { background-color: var(--danger-color); }
        .status-btn.active.aprobado { background-color: var(--success-color); }
        .status-btn:not(.active):hover { opacity: 0.7; }
        .subsection { background: var(--background-white); padding: 20px; border-radius: 3px; margin: 15px 0; box-shadow: 0 1px 1px rgba(9,30,66,.25); }
        .subsection h3 { color: var(--text-dark); margin-bottom: 15px; font-size: 16px; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        .btn, .btn-action, .btn-secondary, .btn-logout, .btn-save, .btn-danger, .btn-success, .btn-warning { background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: 500; margin: 5px; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover, .btn-action:hover, .btn-secondary:hover, .btn-logout:hover, .btn-save:hover, .btn-danger:hover, .btn-success:hover, .btn-warning:hover { opacity: 0.9; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-warning { background-color: var(--warning-color); color: var(--text-dark); }
        .btn:disabled, .btn-action:disabled, .btn-danger:disabled, .btn-success:disabled { background-color: #a5adba; cursor: not-allowed; opacity: 0.7; }
        .notes-textarea, .form-input, .form-select, .form-textarea { width: 100%; margin-top: 5px; padding: 8px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px; }
        .notes-textarea { resize: none; overflow: hidden; }
        .form-textarea { min-height: 80px; resize: vertical; }
        .voice-btn { background: #f0f7fc; border: 1px solid #dfe1e6; border-radius: 50%; width: 32px; height: 32px; margin-left: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; flex-shrink: 0; }
        .voice-btn:hover { background: var(--primary-color); color: white; }
        .voice-btn.listening { background: #ff4d4d; color: white; animation: pulse 1.5s infinite; }
        .auth-container { max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: 5px; box-shadow: 0 4px 8px rgba(9,30,66,.25); text-align: center; }
        .auth-container h1 { justify-content: center; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 5px; color: white; z-index: 1002; animation: fadeInOut 4s ease-in-out; }
        .notification.success { background-color: #5aac44; }
        .notification.error { background-color: var(--danger-color); }
        .form-label { font-weight: 600; margin-top: 1rem; display: block; font-size: 14px; color: var(--text-dark); text-align: left; }
        .form-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .form-table th, .form-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 14px; vertical-align: middle; }
        .form-table th { background-color: #f8f9fa; font-weight: 600; }
        .form-table input, .form-table select { margin-top: 0; }
        .checkbox-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .checkbox-group label { font-weight: normal; font-size: 14px; display:flex; align-items:center; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001; }
        .modal-content { background: white; padding: 2rem; border-radius: 5px; max-width: 500px; text-align: left; }
        .modal-content-lg { max-width: 800px; text-align: left; }
        .signature-pad { border: 1px solid var(--border-color); border-radius: 3px; cursor: crosshair; }
        .editor-toolbar { background-color: #f4f5f7; border: 1px solid var(--border-color); border-bottom: none; padding: 4px; border-radius: 3px 3px 0 0; display: flex; gap: 8px; align-items: center; }
        .editor-toolbar button { background: none; border: none; cursor: pointer; font-size: 14px; font-weight: bold; padding: 2px 6px; }
        .editor-toolbar button:hover { background-color: #e9ecef; }
        .rich-text-editor { width: 100%; margin-top: 0; padding: 8px; border: 1px solid var(--border-color); border-radius: 0 0 3px 3px; font-size: 14px; min-height: 80px; resize: vertical; overflow: auto; }
        .rich-text-editor:focus { outline: 2px solid var(--primary-color); outline-offset: -2px; }
        .task-content-wrapper table { border-collapse: collapse; margin: 1rem 0; font-size: 13px; width: 100%; }
        .task-content-wrapper th, .task-content-wrapper td { border: 1px solid var(--border-color); padding: 6px 10px; text-align: left; word-wrap: break-word; }
        .task-content-wrapper th { background-color: var(--background-light); font-weight: 600; color: var(--text-dark); }
        .detail-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .detail-section h4 { font-size: 1.125rem; font-weight: 600; color: var(--text-dark); margin-bottom: 1rem; }
        .detail-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1rem; }
        @media (min-width: 768px) { .detail-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        .detail-item { background-color: #f9fafb; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid var(--border-color); }
        .detail-item-full { grid-column: 1 / -1; }
        .detail-label { font-weight: 600; font-size: 0.875rem; color: var(--text-light); display: block; margin-bottom: 0.25rem; }
        .detail-value { font-size: 1rem; color: var(--text-dark); white-space: pre-wrap; word-wrap: break-word; }
        .detail-table { width: 100%; margin-top: 0.5rem; border-collapse: collapse; }
        .detail-table th, .detail-table td { border: 1px solid var(--border-color); padding: 0.5rem; text-align: left; font-size: 0.875rem; }
        .detail-table th { background-color: #f3f4f6; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; transform: translateY(-20px); } 10%, 90% { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .org-chart-dynamic { padding: 20px; overflow: auto; }
        .org-chart-dynamic ul { padding-left: 30px; position: relative; }
        .org-chart-dynamic li { list-style-type: none; margin: 20px 0; position: relative; }
        .org-chart-dynamic li::before, .org-chart-dynamic li::after { content: ''; position: absolute; left: -15px; border-color: #c4cdd5; }
        .org-chart-dynamic li::before { border-top: 2px solid #c4cdd5; top: 50px; width: 15px; height: 0; }
        .org-chart-dynamic li::after { border-left: 2px solid #c4cdd5; height: 100%; width: 0px; top: 2px; }
        .org-chart-dynamic ul > li:last-child::after { height: 50px; }
        .org-node { background-color: #fff; border: 1px solid #dfe1e6; border-radius: 8px; padding: 12px 16px; display: inline-block; min-width: 280px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); position: relative; transition: all 0.3s ease; }
        .org-node:hover { border-color: var(--primary-color); box-shadow: 0 4px 8px rgba(0,0,0,0.12); }
        .node-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .node-role { font-weight: 600; font-size: 16px; color: var(--primary-color); }
        .node-department { font-size: 12px; color: var(--text-light); font-weight: 500; margin-top: 2px; }
        .node-employee { font-size: 14px; color: var(--text-dark); margin-top: 8px; padding-left: 10px; border-left: 2px solid var(--primary-light); }
        .node-description { font-size: 13px; color: #4a5568; margin-top: 8px; white-space: pre-wrap; max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .org-node.is-open .node-description { max-height: 200px; }
        .toggle-button { font-size: 20px; font-weight: bold; color: var(--primary-color); padding: 0 8px; transition: transform 0.3s ease; }
        .org-node.is-open .toggle-button { transform: rotate(90deg); }
        .no-children .toggle-button { visibility: hidden; }
        @media print {
            body, html { background-color: #fff; }
            .header, .navigation, footer, .header-actions, .btn-print-org { display: none !important; }
            .container { max-width: 100%; padding: 0; margin: 0; }
            .subsection { border: none; box-shadow: none; }
            .org-chart-dynamic { overflow: visible; }
            .org-node { box-shadow: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <footer style="color: var(--text-light); font-size: 14px;">
        <div class="flex justify-center mb-4">
            <img src="https://egea.creativiza.com/expansion/logo-783%20(1).png" alt="Logo de EGEA" class="h-10" />
        </div>
        <p class="text-xs text-gray-500 mb-2">Versión 2.2.0 (Final)</p>
        <p style="display: flex; align-items: center; justify-content: center; gap: 5px;">
            Hecho con 
            <svg width="16" height="16" viewBox="0 0 24 24" fill="red" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.39 20.87a.696.696 0 0 1-.78 0C9.764 19.637 2 14.15 2 8.973c0-6.68 7.85-7.75 10-3.25 2.15-4.5 10-3.43 10 3.25 0 5.178-7.764 10.664-9.61 11.895z"/>
            </svg>
             por Hacchi
        </p>
    </footer>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const { createClient } = supabase;
        const { jsPDF } = window.jspdf;

        // --- SUPABASE CREDENTIALS ---
        const supabaseUrl = 'https://mtncylafoftawkuruinu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10bmN5bGFmb2Z0YXdrdXJ1aW51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5Nzc5MzAsImV4cCI6MjA2NzU1MzkzMH0.K3w1EiuhSXGbbEtY0muyDEUXvlxGkmnb9fCrv3eSuOU';
        const supabaseClient = createClient(supabaseUrl, SUPABASE_ANON_KEY);

        // --- FUNCIÓN PARA POBLAR LA BASE DE DATOS (USAR UNA SOLA VEZ Y LUEGO BORRAR) ---
        async function seedStudyPhases() {
            const studyData = [
              { "id": "dashboard", "title": "Dashboard" },
              { "id": "phase-1", "title": "Fase 1: Análisis Preliminar", "sections": [{ "description": "Recopilación inicial de datos y definición del alcance del proyecto.", "tasks": ["1.1: Definir objetivos y alcance del estudio organizativo.", "1.2: Recopilar documentación existente.", "1.3: Realizar entrevistas iniciales con la dirección.", "1.4: Elaborar el plan de trabajo detallado."] }] },
              { "id": "phase-2", "title": "Fase 2: Levantamiento de Información", "sections": [{ "description": "Análisis detallado de la estructura, puestos y procesos actuales.", "tasks": ["2.1: Diseñar cuestionarios y guías de entrevista.", "2.2: Realizar entrevistas con responsables de departamento.", "2.3: Levantar el perfil de cada puesto de trabajo.", "2.4: Mapear los procesos clave de la organización.", "2.5: Analizar la estructura organizativa actual."] }] },
              { "id": "phase-3", "title": "Fase 3: Análisis y Diagnóstico", "sections": [{ "description": "Evaluación de la información recopilada.", "tasks": ["3.1: Analizar la adecuación de los perfiles de puesto.", "3.2: Evaluar la carga de trabajo y distribución de responsabilidades.", "3.3: Identificar duplicidades y cuellos de botella.", "3.4: Analizar los canales de comunicación.", "3.5: Realizar un análisis DAFO de la estructura."] }] },
              { "id": "phase-4", "title": "Fase 4: Propuesta y Diseño", "sections": [{ "description": "Elaboración de la nueva estructura organizativa.", "tasks": ["4.1: Diseñar el nuevo organigrama.", "4.2: Redefinir y documentar los perfiles de puesto (DPT).", "4.3: Optimizar y rediseñar los procesos clave.", "4.4: Proponer un nuevo manual de funciones.", "4.5: Definir nuevos indicadores de gestión (KPIs)."] }] },
              { "id": "phase-5", "title": "Fase 5: Plan de Implantación", "sections": [{ "description": "Definición de la hoja de ruta para implementar los cambios.", "tasks": ["5.1: Elaborar el plan de comunicación.", "5.2: Definir el cronograma de implantación.", "5.3: Desarrollar el plan de formación y capacitación.", "5.4: Establecer un sistema de seguimiento y evaluación.", "5.5: Presentar el informe final y plan de acción."] }] },
              { "id": "summaries", "title": "Resúmenes IA" }
            ];

            const { data, error } = await supabaseClient
                .from('study_phases')
                .upsert(studyData, { onConflict: 'id' });

            if (error) {
                console.error('Error al insertar los datos:', error);
                alert('Error al insertar los datos. Revisa la consola.');
            } else {
                console.log('Datos insertados con éxito:', data);
                alert('¡Las fases del estudio se han guardado en Supabase!');
            }
        }

        // --- STATIC DATA ---
        const PARADO_TAG = '[state:parado]';
        
        // --- ICONS ---
        const MicIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>;
        const LoaderIcon = () => <div className="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>;
        const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const SettingsIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0 2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>;
        const SparklesIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.553L16.5 21.75l-.398-1.197a3.375 3.375 0 00-2.455-2.455L12.75 18l1.197-.398a3.375 3.375 0 002.455 2.455l.398-1.197.398 1.197a3.375 3.375 0 002.455 2.455l1.197.398-1.197.398a3.375 3.375 0 00-2.455 2.455z"/></svg>;
        const CopyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const MenuIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>;
        const XIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const LinkIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>;
        const CodeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>;

        // --- HOOKS ---
        const useAutosizeTextArea = (textAreaRef, value) => {
            useEffect(() => {
                if (textAreaRef && textAreaRef.current) {
                    textAreaRef.current.style.height = "0px";
                    const scrollHeight = textAreaRef.current.scrollHeight;
                    textAreaRef.current.style.height = scrollHeight + "px";
                }
            }, [textAreaRef, value]);
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setLoading(false);
                });
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                });
                return () => subscription.unsubscribe();
            }, []);

            if (loading) {
                return <div className="flex justify-center items-center h-screen"><LoaderIcon /></div>;
            }
            
            return session ? <EstudioApp user={session.user} /> : <Auth />;
        };
        
        // --- AUTH COMPONENT ---
        const Auth = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [view, setView] = useState('express');
            const [message, setMessage] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');
                try {
                    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                } catch (error) {
                    setMessage(error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSignUp = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');
                try {
                    const { data, error } = await supabaseClient.auth.signUp({ email, password });
                    if (error) throw error;
                    if (data.user) {
                        const { error: profileError } = await supabaseClient
                            .from('profiles')
                            .insert({ id: data.user.id, role: 'employee' });
                        if (profileError) throw profileError;
                        
                        await supabaseClient.from('activity_log').insert([{ 
                            action: `🚨 ¡Alarma! Nuevo usuario ${email} dado de alta`, 
                            user_id: data.user.id
                        }]);
                    }
                    setMessage('¡Registro exitoso! Revisa tu correo para verificar la cuenta.');
                } catch (error) {
                    setMessage(`Error: ${error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const handleExpressLink = async (e) => {
                e.preventDefault();
                if (!email) {
                    setMessage("Por favor, introduce tu email para recibir el enlace de acceso.");
                    return;
                }
                setLoading(true);
                setMessage('');
                try {
                    const { error } = await supabaseClient.auth.signInWithOtp({ email });
                    if (error) throw error;
                    setMessage('¡Revisa tu correo! Te hemos enviado un enlace para iniciar sesión.');
                } catch (error) {
                    setMessage(error.message);
                } finally {
                    setLoading(false);
                }
            };
            
            return ( 
                <div className="auth-container"> 
                    <div className="flex justify-center mb-4"><img src="https://egea.creativiza.com/expansion/logo-783%20(1).png" alt="Logo de EGEA" className="h-12" /></div>
                    {view === 'express' && (
                         <>
                            <h2 className="text-xl font-bold text-center mb-6">Acceso Express</h2> 
                            <form onSubmit={handleExpressLink} className="space-y-4"> 
                                <input type="email" placeholder="tu-correo@egea.com" value={email} onChange={e => setEmail(e.target.value)} required className="w-full p-2 border rounded-md text-center" /> 
                                <button type="submit" className="w-full btn-success justify-center" disabled={loading}>{loading ? <LoaderIcon /> : 'Enviar Enlace de Acceso'}</button> 
                            </form>
                            <div className="mt-4 text-center">
                                <a href="#" onClick={(e) => { e.preventDefault(); setView('login'); }} className="text-sm text-blue-600 hover:underline">O iniciar sesión con contraseña</a>
                            </div>
                        </>
                    )}
                    {view === 'login' && (
                        <>
                            <h2 className="text-xl font-bold text-center mb-6">Iniciar Sesión</h2> 
                            <form onSubmit={handleLogin} className="space-y-4"> 
                                <input type="email" placeholder="correo@ejemplo.com" value={email} onChange={e => setEmail(e.target.value)} required className="w-full p-2 border rounded-md text-center" /> 
                                <input type="password" placeholder="Contraseña" value={password} onChange={e => setPassword(e.target.value)} required className="w-full p-2 border rounded-md text-center" /> 
                                <button type="submit" className="w-full btn-action justify-center" disabled={loading}>{loading ? <LoaderIcon /> : 'Entrar'}</button> 
                            </form>
                            <p className="text-center mt-4">
                                <a href="#" onClick={(e) => { e.preventDefault(); setView('signUp'); }} className="text-sm text-blue-600 hover:underline">¿No tienes cuenta? Regístrate</a>
                            </p>
                             <div className="mt-2 text-center">
                                <a href="#" onClick={(e) => { e.preventDefault(); setView('express'); }} className="text-xs text-gray-500 hover:underline">Volver a Acceso Express</a>
                            </div>
                        </>
                    )}
                    {view === 'signUp' && (
                         <>
                            <h2 className="text-xl font-bold text-center mb-6">Registrarse</h2> 
                            <form onSubmit={handleSignUp} className="space-y-4"> 
                                <input type="email" placeholder="correo@ejemplo.com" value={email} onChange={e => setEmail(e.target.value)} required className="w-full p-2 border rounded-md text-center" /> 
                                <input type="password" placeholder="Crea una contraseña" value={password} onChange={e => setPassword(e.target.value)} required className="w-full p-2 border rounded-md text-center" /> 
                                <button type="submit" className="w-full btn-action justify-center" disabled={loading}>{loading ? <LoaderIcon /> : 'Crear Cuenta'}</button> 
                            </form>
                             <p className="text-center mt-4">
                                <a href="#" onClick={(e) => { e.preventDefault(); setView('login'); }} className="text-sm text-blue-600 hover:underline">¿Ya tienes cuenta? Inicia sesión</a>
                            </p>
                        </>
                    )}
                    {message && <p className={`mt-4 text-center text-sm ${message.startsWith('Error') ? 'text-red-600' : 'text-green-600'}`}>{message}</p>} 
                </div> 
            );
        };
        
        // --- TASK ITEM COMPONENT ---
        const TaskItem = ({ taskId, taskState, onStatusChange, onNoteChange, onRecord, onSummarize, onEditClick }) => {
            const { isRecording, isProcessing, activeTaskId } = onRecord;
            const { status, notes, is_editing } = taskState;
            const summarySeparator = '--- Resumen IA ---';
            
            const [mainNotes, summaryText] = useMemo(() => {
                const rawNotes = notes || '';
                const userNotes = rawNotes.replace(PARADO_TAG, '').trim();
                const hasSummary = userNotes.includes(summarySeparator);
                const main = hasSummary ? userNotes.split(summarySeparator)[0].trim() : userNotes;
                const summary = hasSummary ? userNotes.split(summarySeparator)[1].trim() : null;
                return [main, summary];
            }, [notes]);
            
            const editorRef = useRef(null);
            const [isSaving, setIsSaving] = useState(false);

            const handleContentUpdate = () => {
                if (editorRef.current) {
                    const newContent = editorRef.current.innerHTML;
                    if (newContent !== mainNotes) {
                        const finalNotes = summaryText ? `${newContent}\n\n${summarySeparator}\n${summaryText}` : newContent;
                        onNoteChange(taskId, { notes: finalNotes, is_editing: true }, false);
                    }
                }
            };

            const handleSave = async () => {
                if (!editorRef.current) return;
                setIsSaving(true);
                const newContent = editorRef.current.innerHTML;
                const finalNotes = summaryText ? `${newContent}\n\n${summarySeparator}\n${summaryText}` : newContent;
                await onNoteChange(taskId, { notes: finalNotes, is_editing: false }, true);
                setIsSaving(false);
            };

            const handleDeleteSummary = () => {
                onNoteChange(taskId, { notes: mainNotes }, true);
            };
            
            const handleFormat = (command, value = null) => {
                if (editorRef.current) {
                    editorRef.current.focus();
                    document.execCommand(command, false, value);
                    handleContentUpdate();
                }
            };

            const handleEmbed = () => {
                const embedCode = prompt('Pega aquí el código HTML para incrustar (ej: de Google Sheets):');
                if (embedCode && editorRef.current) {
                    editorRef.current.focus();
                    const wrapperHtml = `<div style="overflow: auto; width: 100%;">${embedCode}</div>`;
                    document.execCommand('insertHTML', false, wrapperHtml);
                    handleContentUpdate();
                }
            };

            return (
                 <li className={`status-${status}`}>
                    <div className="flex flex-col gap-2">
                        <div className="flex justify-between items-center gap-4">
                            <span className="task-title">{taskId}</span>
                            <div className="flex items-center flex-shrink-0">
                                <div className="task-status-selector" title="Cambiar estado">
                                    <button onClick={() => onStatusChange(taskId, { status: 'pendiente' })} className={`status-btn pendiente ${status === 'pendiente' ? 'active' : ''}`}>Pendiente</button>
                                    <button onClick={() => onStatusChange(taskId, { status: 'parado' })} className={`status-btn parado ${status === 'parado' ? 'active' : ''}`}>Parado</button>
                                    <button onClick={() => onStatusChange(taskId, { status: 'aprobado' })} className={`status-btn aprobado ${status === 'aprobado' ? 'active' : ''}`}>Aprobado</button>
                                </div>
                                <button onClick={() => onEditClick(taskId, !is_editing)} className="btn-secondary text-xs px-2 py-1 ml-4">{is_editing ? 'Cerrar' : 'Editar'}</button>
                            </div>
                        </div>
                        <div className="border-t border-gray-200 pt-2 task-content-wrapper">
                            {is_editing ? (
                                <div className="mt-2">
                                    <div className="editor-toolbar">
                                        <button onMouseDown={(e) => e.preventDefault()} onClick={() => handleFormat('bold')} title="Negrita"><b>B</b></button>
                                        <button onMouseDown={(e) => e.preventDefault()} onClick={() => handleFormat('italic')} title="Cursiva" style={{fontStyle: 'italic'}}>I</button>
                                        <button onMouseDown={(e) => e.preventDefault()} onClick={() => handleFormat('createLink', prompt('Introduce la URL:'))} title="Enlace"><LinkIcon /></button>
                                        <button onMouseDown={(e) => e.preventDefault()} onClick={handleEmbed} title="Incrustar HTML"><CodeIcon /></button>
                                    </div>
                                    <div ref={editorRef} className="rich-text-editor" contentEditable={true} onBlur={handleContentUpdate} dangerouslySetInnerHTML={{ __html: mainNotes }} />
                                    <div className="flex items-center justify-between mt-2">
                                        <div>
                                            <button onClick={() => onSummarize(taskId)} className="btn-secondary text-xs px-2 py-1" disabled={isProcessing || !mainNotes || isRecording || isSaving}>
                                                {(isProcessing && activeTaskId === taskId) ? <LoaderIcon /> : 'Resumen IA'}
                                            </button>
                                            {summaryText && (<button onClick={handleDeleteSummary} className="btn-danger text-xs px-2 py-1 ml-2">Borrar Resumen</button>)}
                                        </div>
                                        <div className="flex items-center">
                                             <button type="button" onClick={() => onRecord.handle(taskId)} className={`voice-btn ${isRecording && activeTaskId === taskId ? 'listening' : ''}`} disabled={isProcessing || isSaving}>
                                                {(isRecording && activeTaskId === taskId) ? <LoaderIcon /> : <MicIcon />}
                                             </button>
                                             <button type="button" onClick={handleSave} className="btn-success text-xs px-2 py-1 ml-2" disabled={isSaving || isProcessing || isRecording}>{isSaving ? <LoaderIcon /> : 'Guardar y Cerrar'}</button>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    {mainNotes && <div className="mt-2 text-sm text-gray-700 pl-1 w-full" dangerouslySetInnerHTML={{ __html: mainNotes }}></div>}
                                    {summaryText && (
                                        <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                            <h4 className="font-semibold text-sm text-blue-800">Resumen de IA</h4>
                                            <p className="mt-1 text-sm text-gray-700 whitespace-pre-wrap">{summaryText}</p>
                                        </div>
                                    )}
                                    {!mainNotes && !summaryText && <p className="text-xs text-gray-400 italic mt-2 pl-1">No hay notas para esta tarea. Haz clic en "Editar" para añadir contenido.</p>}
                                </>
                            )}
                        </div>
                    </div>
                </li>
            );
        };

        // --- JOB PROFILE FORM COMPONENT ---
        const JobProfileForm = ({ user, onSave, onCancel, showNotification, profileToEdit, predefinedOptions, logActivity }) => {
            const [formData, setFormData] = useState({
                nombre_apellidos: '', nombre_puesto: '', departamento: '', ubicacion: '', reporta_a: '', proposito: '',
                competencias_tecnicas: '', competencias_transversales: '', formacion: '', experiencia: '', horario: '',
                tipo_contrato: '', modalidad_trabajo: '', riesgos: '', herramientas: '', observaciones: '', firmado_por: '', fecha_firma: '', signature_data_url: ''
            });
            const [subordinados, setSubordinados] = useState(['']);
            const [funciones, setFunciones] = useState([{ funcion: '', frecuencia: [], responsabilidad: [] }]);
            const [kpis, setKpis] = useState(['']);
            const [relaciones, setRelaciones] = useState([{ tipo: 'Interna', con_quien: '', motivo: '' }]);
            const [isSaving, setIsSaving] = useState(false);
            const signaturePadRef = useRef(null);
            const canvasRef = useRef(null);

            const resizeCanvas = useCallback(() => {
                if (canvasRef.current) {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    const canvas = canvasRef.current;
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    if (signaturePadRef.current) {
                        signaturePadRef.current.fromData(signaturePadRef.current.toData());
                    }
                }
            }, []);

            useEffect(() => {
                if (canvasRef.current) {
                    signaturePadRef.current = new SignaturePad(canvasRef.current);
                    resizeCanvas();
                    window.addEventListener("resize", resizeCanvas);
                    if (profileToEdit && profileToEdit.signature_data_url) {
                        signaturePadRef.current.fromDataURL(profileToEdit.signature_data_url);
                    }
                }
                return () => {
                    window.removeEventListener("resize", resizeCanvas);
                };
            }, [profileToEdit, resizeCanvas]);

            useEffect(() => {
                if (profileToEdit) {
                    setFormData({
                        nombre_apellidos: profileToEdit.nombre_apellidos || '',
                        nombre_puesto: profileToEdit.nombre_puesto || '',
                        departamento: profileToEdit.departamento || '',
                        ubicacion: profileToEdit.ubicacion || '',
                        reporta_a: profileToEdit.reporta_a || '',
                        proposito: profileToEdit.proposito || '',
                        competencias_tecnicas: profileToEdit.competencias_tecnicas || '',
                        competencias_transversales: profileToEdit.competencias_transversales || '',
                        formacion: profileToEdit.formacion || '',
                        experiencia: profileToEdit.experiencia || '',
                        horario: profileToEdit.horario || '',
                        tipo_contrato: profileToEdit.tipo_contrato || '',
                        modalidad_trabajo: profileToEdit.modalidad_trabajo || '',
                        riesgos: profileToEdit.riesgos || '',
                        herramientas: profileToEdit.herramientas || '',
                        observaciones: profileToEdit.observaciones || '',
                        firmado_por: profileToEdit.firmado_por || '',
                        fecha_firma: profileToEdit.fecha_firma || '',
                        signature_data_url: profileToEdit.signature_data_url || '',
                        approved: profileToEdit.approved || false,
                    });
                    setSubordinados(profileToEdit.subordinados && profileToEdit.subordinados.length > 0 ? profileToEdit.subordinados : ['']);
                    setFunciones(profileToEdit.funciones && profileToEdit.funciones.length > 0 ? profileToEdit.funciones : [{ funcion: '', frecuencia: [], responsabilidad: [] }]);
                    setKpis(profileToEdit.kpis && profileToEdit.kpis.length > 0 ? profileToEdit.kpis : ['']);
                    setRelaciones(profileToEdit.relaciones && profileToEdit.relaciones.length > 0 ? profileToEdit.relaciones : [{ tipo: 'Interna', con_quien: '', motivo: '' }]);
                }
            }, [profileToEdit]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            
            const handleDynamicChange = (setter, index, field, value) => {
                setter(prev => {
                    const items = [...prev];
                    if (field) {
                        items[index][field] = value;
                    } else {
                        items[index] = value;
                    }
                    return items;
                });
            };
            
            const handleCheckboxChange = (setter, index, field, value) => {
                setter(prev => {
                    const items = [...prev];
                    const currentValues = items[index][field] || [];
                    if (currentValues.includes(value)) {
                        items[index][field] = currentValues.filter(v => v !== value);
                    } else {
                        items[index][field] = [...currentValues, value];
                    }
                    return items;
                });
            };

            const addDynamicItem = (setter, newItem) => setter(prev => [...prev, newItem]);
            const removeDynamicItem = (setter, index) => setter(prev => prev.filter((_, i) => i !== index));

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                
                let signatureURL = formData.signature_data_url;
                if (signaturePadRef.current && !signaturePadRef.current.isEmpty()) {
                    signatureURL = signaturePadRef.current.toDataURL();
                }

                const completeData = {
                    ...formData,
                    user_id: user.id,
                    signature_data_url: signatureURL,
                    subordinados: subordinados.filter(s => s && s.trim() !== ''),
                    funciones: funciones.filter(f => f.funcion && f.funcion.trim() !== ''),
                    kpis: kpis.filter(k => k && k.trim() !== ''),
                    relaciones: relaciones.filter(r => r.con_quien && r.con_quien.trim() !== '')
                };
                
                try {
                    let error;
                    if (profileToEdit) {
                        const { error: updateError } = await supabaseClient.from('job_profiles').update(completeData).eq('id', profileToEdit.id);
                        error = updateError;
                        if (!error) logActivity(`Editada ficha de ${completeData.nombre_apellidos}`);
                    } else {
                        const newId = Math.random().toString(36).substring(2, 8).toUpperCase();
                        const { error: insertError } = await supabaseClient.from('job_profiles').insert([{ ...completeData, id: newId }]);
                        error = insertError;
                        if (!error) logActivity(`Creada ficha de ${completeData.nombre_apellidos}`);
                    }

                    if (error) throw error;
                    showNotification(`Ficha de puesto ${profileToEdit ? 'actualizada' : 'guardada'} con éxito.`, 'success');
                    onSave();
                } catch (error) {
                    showNotification(`Error al ${profileToEdit ? 'actualizar' : 'guardar'} la ficha: ${error.message}`, 'error');
                } finally {
                    setIsSaving(false);
                }
            };
            
            return (
                <div className="subsection">
                    <form onSubmit={handleSubmit}>
                        <h2 className="text-xl font-bold mb-4 border-b pb-2">{profileToEdit ? 'Editar' : 'Nueva'} Ficha de Puesto de Trabajo</h2>
                        <h3 className="text-lg font-semibold mt-4">1. Identificación del Puesto</h3>
                        <label className="form-label" htmlFor="nombre_apellidos">Nombre y Apellidos</label>
                        <input className="form-input" type="text" id="nombre_apellidos" name="nombre_apellidos" value={formData.nombre_apellidos} onChange={handleInputChange} required />
                        <label className="form-label" htmlFor="nombre_puesto">Puesto</label>
                        <select className="form-select" id="nombre_puesto" name="nombre_puesto" value={formData.nombre_puesto} onChange={handleInputChange} required>
                            <option value="">Selecciona un puesto...</option>
                            {predefinedOptions.puestos.map(puesto => <option key={puesto} value={puesto}>{puesto}</option>)}
                        </select>
                        <label className="form-label" htmlFor="departamento">Departamento / Área</label>
                        <select className="form-select" id="departamento" name="departamento" value={formData.departamento} onChange={handleInputChange} required>
                            <option value="">Selecciona un departamento...</option>
                            {predefinedOptions.departamentos.map(dep => <option key={dep} value={dep}>{dep}</option>)}
                        </select>
                        <label className="form-label" htmlFor="ubicacion">Ubicación</label>
                        <input className="form-input" type="text" id="ubicacion" name="ubicacion" value={formData.ubicacion} onChange={handleInputChange} />
                        <label className="form-label" htmlFor="reporta_a">Reporta a</label>
                         <select className="form-select" id="reporta_a" name="reporta_a" value={formData.reporta_a} onChange={handleInputChange}>
                            <option value="">Selecciona a quién reporta...</option>
                            {predefinedOptions.reporta_a.map(rep => <option key={rep} value={rep}>{rep}</option>)}
                        </select>
                        <label className="form-label">Subordinados directos</label>
                        {subordinados.map((sub, index) => (
                            <div key={index} className="flex gap-2 mb-2">
                                <input className="form-input" type="text" value={sub} onChange={e => handleDynamicChange(setSubordinados, index, null, e.target.value)} placeholder="Puesto del subordinado"/>
                                {index > 0 && <button type="button" onClick={() => removeDynamicItem(setSubordinados, index)} className="btn-danger p-2 leading-none">X</button>}
                            </div>
                        ))}
                        <button type="button" onClick={() => addDynamicItem(setSubordinados, '')} className="btn-secondary text-sm mt-1">+ Añadir subordinado</button>
                        <h3 className="text-lg font-semibold mt-6">2. Propósito y Funciones</h3>
                        <label className="form-label" htmlFor="proposito">Propósito General del Puesto</label>
                        <textarea className="form-textarea" id="proposito" name="proposito" value={formData.proposito} onChange={handleInputChange} required></textarea>
                        <label className="form-label mt-6">Funciones y Tareas Principales</label>
                        <table className="form-table">
                            <thead><tr><th style={{width: '5%'}}>#</th><th>Función / Tarea</th><th>Frecuencia</th><th>Responsabilidad</th><th style={{width: '5%'}}></th></tr></thead>
                            <tbody>
                            {funciones.map((item, index) => (
                                <tr key={index}>
                                    <td>{index + 1}</td>
                                    <td><input type="text" placeholder="Función / Tarea" className="form-input" value={item.funcion} onChange={e => handleDynamicChange(setFunciones, index, 'funcion', e.target.value)} /></td>
                                    <td>
                                        <div className="checkbox-group">
                                            {['Diaria', 'Semanal', 'Mensual'].map(freq => <label key={freq}><input type="checkbox" className="mr-1" checked={(item.frecuencia || []).includes(freq)} onChange={() => handleCheckboxChange(setFunciones, index, 'frecuencia', freq)}/>{freq}</label>)}
                                        </div>
                                    </td>
                                    <td>
                                        <div className="checkbox-group">
                                            {['Alta', 'Media', 'Baja'].map(resp => <label key={resp}><input type="checkbox" className="mr-1" checked={(item.responsabilidad || []).includes(resp)} onChange={() => handleCheckboxChange(setFunciones, index, 'responsabilidad', resp)}/>{resp}</label>)}
                                        </div>
                                    </td>
                                    <td>{index > 0 && <button type="button" onClick={() => removeDynamicItem(setFunciones, index)} className="btn-danger p-2 leading-none">X</button>}</td>
                                </tr>
                            ))}
                            </tbody>
                        </table>
                        <button type="button" onClick={() => addDynamicItem(setFunciones, { funcion: '', frecuencia: [], responsabilidad: [] })} className="btn-secondary text-sm mt-2">+ Añadir función</button>
                        <h3 className="text-lg font-semibold mt-6">3. KPIs y Observaciones</h3>
                        <label className="form-label">KPIs / Indicadores de Desempeño</label>
                        {kpis.map((kpi, index) => (
                            <div key={index} className="flex gap-2 mb-2">
                                <input className="form-input" type="text" value={kpi} onChange={e => handleDynamicChange(setKpis, index, null, e.target.value)} placeholder="Ej: Nivel de satisfacción del cliente > 90%"/>
                                {index > 0 && <button type="button" onClick={() => removeDynamicItem(setKpis, index)} className="btn-danger p-2 leading-none">X</button>}
                            </div>
                        ))}
                        <button type="button" onClick={() => addDynamicItem(setKpis, '')} className="btn-secondary text-sm mt-1">+ Añadir KPI</button>
                        <label className="form-label mt-6" htmlFor="observaciones">Observaciones</label>
                        <textarea className="form-textarea" name="observaciones" id="observaciones" value={formData.observaciones} onChange={handleInputChange}></textarea>
                        <h3 className="text-lg font-semibold mt-6">4. Competencias Requeridas</h3>
                        <label className="form-label" htmlFor="competencias_tecnicas">Competencias técnicas / específicas</label>
                        <textarea className="form-textarea" id="competencias_tecnicas" name="competencias_tecnicas" value={formData.competencias_tecnicas} onChange={handleInputChange}></textarea>
                        <label className="form-label" htmlFor="competencias_transversales">Competencias transversales / blandas</label>
                        <textarea className="form-textarea" id="competencias_transversales" name="competencias_transversales" value={formData.competencias_transversales} onChange={handleInputChange}></textarea>
                        <label className="form-label" htmlFor="formacion">Formación mínima requerida</label>
                        <input className="form-input" type="text" id="formacion" name="formacion" value={formData.formacion} onChange={handleInputChange} />
                        <label className="form-label" htmlFor="experiencia">Experiencia mínima requerida</label>
                        <input className="form-input" type="text" id="experiencia" name="experiencia" value={formData.experiencia} onChange={handleInputChange} />
                        <h3 className="text-lg font-semibold mt-6">5. Condiciones del Puesto</h3>
                        <label className="form-label" htmlFor="horario">Horario</label>
                        <input className="form-input" type="text" id="horario" name="horario" value={formData.horario} onChange={handleInputChange} placeholder="Ej: 09:00 - 18:00"/>
                        <label className="form-label" htmlFor="tipo_contrato">Tipo de contrato</label>
                        <select className="form-select" id="tipo_contrato" name="tipo_contrato" value={formData.tipo_contrato} onChange={handleInputChange}>
                            <option value="">Selecciona un tipo de contrato...</option>
                            {predefinedOptions.tipos_contrato.map(con => <option key={con} value={con}>{con}</option>)}
                        </select>
                        <label className="form-label" htmlFor="modalidad_trabajo">Modalidad de trabajo</label>
                        <select className="form-select" id="modalidad_trabajo" name="modalidad_trabajo" value={formData.modalidad_trabajo} onChange={handleInputChange}>
                            <option value="">Selecciona una modalidad...</option>
                            {predefinedOptions.modalidades_trabajo.map(mod => <option key={mod} value={mod}>{mod}</option>)}
                        </select>
                        <label className="form-label" htmlFor="riesgos">Riesgos asociados</label>
                        <textarea className="form-textarea" id="riesgos" name="riesgos" value={formData.riesgos} onChange={handleInputChange}></textarea>
                        <label className="form-label" htmlFor="herramientas">Equipos o herramientas clave</label>
                        <textarea className="form-textarea" id="herramientas" name="herramientas" value={formData.herramientas} onChange={handleInputChange}></textarea>
                        <h3 className="text-lg font-semibold mt-6">6. Relaciones Internas y Externas</h3>
                        <table className="form-table">
                            <thead><tr><th>Tipo</th><th>Con quién</th><th>Motivo / Resultado esperado</th><th style={{width: '5%'}}></th></tr></thead>
                            <tbody>
                            {relaciones.map((item, index) => (
                                <tr key={index}>
                                    <td>
                                        <select className="form-select" value={item.tipo} onChange={e => handleDynamicChange(setRelaciones, index, 'tipo', e.target.value)}>
                                            <option>Interna</option>
                                            <option>Externa</option>
                                        </select>
                                    </td>
                                    <td><input type="text" placeholder="Con quién" className="form-input" value={item.con_quien} onChange={e => handleDynamicChange(setRelaciones, index, 'con_quien', e.target.value)} /></td>
                                    <td><input type="text" placeholder="Motivo" className="form-input" value={item.motivo} onChange={e => handleDynamicChange(setRelaciones, index, 'motivo', e.target.value)} /></td>
                                    <td>{index > 0 && <button type="button" onClick={() => removeDynamicItem(setRelaciones, index)} className="btn-danger p-2 leading-none">X</button>}</td>
                                </tr>
                            ))}
                            </tbody>
                        </table>
                        <button type="button" onClick={() => addDynamicItem(setRelaciones, { tipo: 'Interna', con_quien: '', motivo: '' })} className="btn-secondary text-sm mt-2">+ Añadir relación</button>
                        <h3 className="text-lg font-semibold mt-6">7. Firma</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="form-label" htmlFor="firmado_por">Firmado por</label>
                                <input className="form-input" type="text" id="firmado_por" name="firmado_por" value={formData.firmado_por} onChange={handleInputChange} required />
                            </div>
                            <div>
                                <label className="form-label" htmlFor="fecha_firma">Fecha</label>
                                <input className="form-input" type="date" id="fecha_firma" name="fecha_firma" value={formData.fecha_firma} onChange={handleInputChange} required />
                            </div>
                        </div>
                        <div className="mt-4">
                            <label className="form-label">Panel de Firma</label>
                            <canvas ref={canvasRef} className="signature-pad w-full h-40"></canvas>
                            <button type="button" onClick={() => signaturePadRef.current && signaturePadRef.current.clear()} className="btn-secondary text-sm mt-2">Limpiar Firma</button>
                        </div>
                        <div className="mt-6 flex justify-end gap-4">
                            <button type="button" onClick={onCancel} className="btn-secondary">Cancelar</button>
                            <button type="submit" className="btn-action" disabled={isSaving}>{isSaving && <LoaderIcon />}{isSaving ? 'Guardando...' : 'Guardar Cambios'}</button>
                        </div>
                    </form>
                </div>
            );
        };
        
        // --- MODAL & DETAIL COMPONENTS ---
        const ConfirmationModal = ({ message, onConfirm, onCancel }) => {
            return (
                <div className="modal-overlay">
                    <div className="modal-content text-center">
                        <p className="mb-4">{message}</p>
                        <div className="flex justify-center gap-4">
                            <button onClick={onCancel} className="btn-secondary">Cancelar</button>
                            <button onClick={onConfirm} className="btn-danger">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const JobProfileDetail = ({ profile, onBack, onEdit, onDelete, onExportPDF, onGenerateDescription, userRole }) => {
            const detailRef = useRef(null);
            
            const DetailItem = ({ label, value }) => (
                <div className="detail-item">
                    <span className="detail-label">{label}</span>
                    <p className="detail-value">{value || <span className="text-gray-400">N/A</span>}</p>
                </div>
            );

            const DetailTextarea = ({ label, value }) => (
                 <div className="detail-item detail-item-full">
                    <span className="detail-label">{label}</span>
                    <p className="detail-value">{value || <span className="text-gray-400">N/A</span>}</p>
                </div>
            );

            return (
                <div className="subsection">
                    <div ref={detailRef} className="p-4">
                        <h2 className="text-xl font-bold mb-4 border-b pb-2">Detalle de la Ficha de Puesto: {profile.nombre_apellidos}</h2>
                        <div className="detail-section">
                            <h4>1. Identificación del Puesto</h4>
                            <div className="detail-grid">
                                <DetailItem label="ID Ficha" value={profile.id} />
                                <DetailItem label="Nombre y Apellidos" value={profile.nombre_apellidos} />
                                <DetailItem label="Puesto" value={profile.nombre_puesto} />
                                <DetailItem label="Departamento" value={profile.departamento} />
                                <DetailItem label="Ubicación" value={profile.ubicacion} />
                                <DetailItem label="Reporta a" value={profile.reporta_a} />
                                <div className="detail-item detail-item-full">
                                    <span className="detail-label">Subordinados Directos</span>
                                    {profile.subordinados && profile.subordinados.length > 0 ? (
                                        <ul className="list-disc pl-5 detail-value">
                                            {profile.subordinados.map((item, index) => <li key={index}>{item}</li>)}
                                        </ul>
                                    ) : <p className="detail-value text-gray-400">N/A</p>}
                                </div>
                            </div>
                        </div>
                        <div className="detail-section">
                            <h4>2. Propósito y Funciones</h4>
                             <DetailTextarea label="Propósito General del Puesto" value={profile.proposito} />
                             <div className="detail-item detail-item-full mt-4">
                                <span className="detail-label">Funciones y Tareas Principales</span>
                                {profile.funciones && profile.funciones.length > 0 ? (
                                    <table className="detail-table">
                                        <thead><tr><th>Función</th><th>Frecuencia</th><th>Responsabilidad</th></tr></thead>
                                        <tbody>
                                            {profile.funciones.map((f, i) => (
                                                <tr key={i}>
                                                    <td>{f.funcion}</td>
                                                    <td>{(f.frecuencia || []).join(', ')}</td>
                                                    <td>{(f.responsabilidad || []).join(', ')}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                ) : <p className="detail-value text-gray-400">N/A</p>}
                            </div>
                        </div>
                        <div className="detail-section">
                            <h4>3. KPIs y Observaciones</h4>
                             <div className="detail-item detail-item-full">
                                <span className="detail-label">KPIs / Indicadores de Desempeño</span>
                                {profile.kpis && profile.kpis.length > 0 ? (
                                    <ul className="list-disc pl-5 detail-value">
                                        {profile.kpis.map((item, index) => <li key={index}>{item}</li>)}
                                    </ul>
                                ) : <p className="detail-value text-gray-400">N/A</p>}
                            </div>
                            <DetailTextarea label="Observaciones" value={profile.observaciones} />
                        </div>
                        <div className="detail-section">
                            <h4>4. Competencias Requeridas</h4>
                            <div className="detail-grid">
                                <DetailTextarea label="Competencias Técnicas" value={profile.competencias_tecnicas} />
                                <DetailTextarea label="Competencias Transversales" value={profile.competencias_transversales} />
                                <DetailItem label="Formación Mínima" value={profile.formacion} />
                                <DetailItem label="Experiencia Mínima" value={profile.experiencia} />
                            </div>
                        </div>
                        <div className="detail-section">
                            <h4>5. Condiciones del Puesto</h4>
                            <div className="detail-grid">
                                <DetailItem label="Horario" value={profile.horario} />
                                <DetailItem label="Tipo de Contrato" value={profile.tipo_contrato} />
                                <DetailItem label="Modalidad de Trabajo" value={profile.modalidad_trabajo} />
                                <DetailTextarea label="Riesgos Asociados" value={profile.riesgos} />
                                <DetailTextarea label="Equipos o Herramientas Clave" value={profile.herramientas} />
                            </div>
                        </div>
                        <div className="detail-section">
                            <h4>6. Relaciones</h4>
                             <div className="detail-item detail-item-full">
                                <span className="detail-label">Relaciones Internas y Externas</span>
                                {profile.relaciones && profile.relaciones.length > 0 ? (
                                    <table className="detail-table">
                                        <thead><tr><th>Tipo</th><th>Con Quién</th><th>Motivo</th></tr></thead>
                                        <tbody>
                                            {profile.relaciones.map((r, i) => (
                                                <tr key={i}>
                                                    <td>{r.tipo}</td>
                                                    <td>{r.con_quien}</td>
                                                    <td>{r.motivo}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                ) : <p className="detail-value text-gray-400">N/A</p>}
                            </div>
                        </div>
                        {profile.signature_data_url && (
                             <div className="detail-section">
                                 <h4>7. Firma</h4>
                                 <div className="detail-grid">
                                     <DetailItem label="Firmado Por" value={profile.firmado_por} />
                                     <DetailItem label="Fecha de Firma" value={profile.fecha_firma} />
                                 </div>
                                 <img src={profile.signature_data_url} alt="Firma" className="mt-4 border rounded max-w-xs" />
                             </div>
                        )}
                    </div>
                    <div className="flex flex-wrap justify-end gap-2 mt-4 border-t pt-4">
                        <button onClick={onBack} className="btn-secondary">Volver</button>
                        <button onClick={() => onExportPDF(detailRef, profile.nombre_apellidos)} className="btn-action">Exportar a PDF</button>
                        <button onClick={onGenerateDescription} className="btn-success"><SparklesIcon />Generar Descripción</button>
                        <button onClick={onEdit} className="btn-warning">Editar</button>
                        {userRole === 'admin' && (<button onClick={onDelete} className="btn-danger">Eliminar</button>)}
                    </div>
                </div>
            );
        }
        
        const GeneradorDescripcionModal = ({ profile, onClose, openaiApiKey, aiModel, showNotification }) => {
            const [descripcion, setDescripcion] = useState('');
            const [isGenerating, setIsGenerating] = useState(true);
            const [copyButtonText, setCopyButtonText] = useState('Copiar');

            const buildPrompt = (profile) => {
                const formatList = (items, field) => items && items.length > 0 ? items.map(item => `- ${item[field]}`).join('\n') : 'No especificadas';
                const responsabilidades = formatList(profile.funciones, 'funcion');
                const requisitos = profile.competencias_tecnicas ? profile.competencias_tecnicas.split('\n').filter(r => r.trim() !== '').map(r => `- ${r}`).join('\n') : 'No especificados';
                return `Por favor, genera una descripción de puesto de trabajo profesional y atractiva en español para publicar en un portal de empleo. Utiliza un tono profesional y amigable.
                    Aquí está la información detallada del puesto:
                    - **Nombre de la empresa:** EGEA
                    - **Nombre del puesto:** ${profile.nombre_puesto}
                    - **Departamento / Área:** ${profile.departamento || 'No especificado'}
                    - **Ubicación:** ${profile.ubicacion || 'No especificada'}
                    - **Reporta a:** ${profile.reporta_a || 'No especificado'}
                    - **Formación mínima requerida:** ${profile.formacion || 'No especificada'}
                    - **Experiencia mínima requerida:** ${profile.experiencia || 'No especificada'}
                    - **Horario:** ${profile.horario || 'No especificado'}
                    - **Tipo de contrato:** ${profile.tipo_contrato || 'No especificado'}
                    - **Modalidad de trabajo:** ${profile.modalidad_trabajo || 'No especificada'}
                    **Responsabilidades Clave:**
                    ${responsabilidades}
                    **Requisitos Clave:**
                    ${requisitos}
                    **Instrucciones para la estructura:**
                    1.  **Título del Puesto:** Usa el nombre del puesto proporcionado.
                    2.  **Introducción:** Escribe un párrafo breve y atractivo sobre la oportunidad de unirse a EGEA.
                    3.  **Responsabilidades Principales:** Crea una lista clara basada en las responsabilidades.
                    4.  **Requisitos y Cualificaciones:** Detalla lo necesario para el puesto.
                    5.  **Qué Ofrecemos:** Añade una sección sobre los beneficios.
                    6.  **Llamada a la acción:** Termina con una invitación para aplicar.
                    El resultado final debe ser un texto coherente y bien formateado. Usa negritas (con asteriscos) para los subtítulos.`;
            };

            const generateDescription = useCallback(async () => {
                const prompt = buildPrompt(profile);
                setIsGenerating(true);
                setDescripcion('');
                try {
                    if (!openaiApiKey) throw new Error('La clave de API de OpenAI no está configurada.');
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiApiKey}` },
                        body: JSON.stringify({ model: aiModel, messages: [{ role: 'system', content: 'Eres un asistente de RRHH experto en redactar ofertas de empleo.' }, { role: 'user', content: prompt }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    let text = data.choices[0].message.content;
                    text = text.replace(/\*\*(.*?)\*\*/g, '<h3 class="text-md font-bold mt-3 mb-1">$1</h3>').replace(/\n/g, '<br />');
                    setDescripcion(text);
                } catch (error) {
                    setDescripcion(`Hubo un error al generar la descripción: ${error.message}`);
                    showNotification(error.message, 'error');
                } finally {
                    setIsGenerating(false);
                }
            }, [profile, openaiApiKey, aiModel, showNotification]);

            useEffect(() => {
                generateDescription();
            }, [generateDescription]);
            
            const handleCopy = () => {
                const contentEl = document.getElementById('generated-description-content');
                if (contentEl) {
                    navigator.clipboard.writeText(contentEl.innerText).then(() => {
                        setCopyButtonText('¡Copiado!');
                        setTimeout(() => setCopyButtonText('Copiar'), 2000);
                    }, () => showNotification('Error al copiar texto.', 'error'));
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content modal-content-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Descripción de Puesto Generada con {aiModel}</h2>
                            <button onClick={onClose} className="text-2xl font-bold">&times;</button>
                        </div>
                        <div className="p-4 border rounded-md bg-gray-50 max-h-[60vh] overflow-y-auto">
                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center h-40">
                                    <LoaderIcon />
                                    <p className="mt-2 text-gray-600">Generando descripción...</p>
                                </div>
                            ) : (
                                <div id="generated-description-content" dangerouslySetInnerHTML={{ __html: descripcion }}></div>
                            )}
                        </div>
                        <div className="flex justify-end gap-4 mt-4">
                            <button onClick={handleCopy} className="btn-action" disabled={isGenerating}><CopyIcon /> {copyButtonText}</button>
                            <button onClick={onClose} className="btn-secondary">Cerrar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- EMPLEADOS SECTION COMPONENT ---
        const EmpleadosSection = ({ user, showNotification, openaiApiKey, aiModel, logActivity, userRole, predefinedOptions, profileToEdit, setProfileToEdit, jobProfiles, setJobProfiles }) => {
            const [view, setView] = useState('list');
            const [selectedProfile, setSelectedProfile] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [profileToDelete, setProfileToDelete] = useState(null);
            const [showGenerator, setShowGenerator] = useState(false);
            
            useEffect(() => {
                if (profileToEdit) {
                    setSelectedProfile(profileToEdit);
                    setView('detail'); 
                    setProfileToEdit(null);
                }
            }, [profileToEdit, setProfileToEdit]);
            
            const handleFormSave = () => {
                setView('list');
                setSelectedProfile(null);
            };
            
            const handleDeleteConfirm = async () => {
                if (!profileToDelete) return;
                if (userRole !== 'admin') {
                    showNotification('No tienes permiso para eliminar fichas.', 'error');
                    setProfileToDelete(null);
                    return;
                }
                try {
                    const { error } = await supabaseClient.from('job_profiles').delete().eq('id', profileToDelete.id);
                    if (error) throw error;
                    showNotification('Ficha eliminada con éxito.', 'success');
                    logActivity(`Eliminada ficha de ${profileToDelete.nombre_apellidos}`);
                    setJobProfiles(currentProfiles => currentProfiles.filter(p => p.id !== profileToDelete.id));
                    if (selectedProfile && selectedProfile.id === profileToDelete.id) {
                        setView('list');
                        setSelectedProfile(null);
                    }
                } catch (error) {
                    showNotification(`Error al eliminar: ${error.message}.`, 'error');
                } finally {
                    setProfileToDelete(null);
                }
            };

            const handleToggleApprove = async (profile) => {
                 if (userRole !== 'admin' && userRole !== 'management') {
                    showNotification('No tienes permiso para aprobar fichas.', 'error');
                    return;
                }
                const { data, error } = await supabaseClient.from('job_profiles').update({ approved: !profile.approved }).eq('id', profile.id).select().single();
                if (error) {
                    showNotification(`Error al actualizar estado: ${error.message}`, 'error');
                } else {
                    const actionText = data.approved ? `Aprobada ficha de ${profile.nombre_apellidos}` : `Desaprobada ficha de ${profile.nombre_apellidos}`;
                    showNotification('Estado actualizado.', 'success');
                    logActivity(actionText);
                    setJobProfiles(currentProfiles => currentProfiles.map(p => (p.id === profile.id ? data : p)));
                }
            };

            const handleExportPDF = (elementRef, fileName) => {
                if (elementRef.current) {
                    html2canvas(elementRef.current, { scale: 2 }).then((canvas) => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const imgProps = pdf.getImageProperties(imgData);
                        const imgWidth = pdfWidth;
                        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                        let heightLeft = imgHeight;
                        let position = 0;
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pdfHeight;
                        while (heightLeft >= 0) {
                          position = heightLeft - imgHeight;
                          pdf.addPage();
                          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                          heightLeft -= pdfHeight;
                        }
                        pdf.save(`${fileName || 'ficha'}.pdf`);
                        logActivity(`Exportado PDF de ${fileName}`);
                    });
                }
            };

            const filteredProfiles = jobProfiles.filter(profile =>
                (profile.nombre_apellidos && profile.nombre_apellidos.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (profile.nombre_puesto && profile.nombre_puesto.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            if (view === 'create') return <JobProfileForm user={user} onSave={handleFormSave} onCancel={() => setView('list')} showNotification={showNotification} predefinedOptions={predefinedOptions} logActivity={logActivity} />;
            if (view === 'edit') return <JobProfileForm user={user} onSave={handleFormSave} onCancel={() => { setView('detail'); }} showNotification={showNotification} profileToEdit={selectedProfile} predefinedOptions={predefinedOptions} logActivity={logActivity} />;
            if (view === 'detail' && selectedProfile) {
                return (
                    <>
                        {profileToDelete && <ConfirmationModal message={`¿Seguro que quieres eliminar la ficha de ${profileToDelete.nombre_apellidos}?`} onConfirm={handleDeleteConfirm} onCancel={() => setProfileToDelete(null)} />}
                        {showGenerator && <GeneradorDescripcionModal profile={selectedProfile} onClose={() => setShowGenerator(false)} openaiApiKey={openaiApiKey} aiModel={aiModel} showNotification={showNotification} />}
                        <JobProfileDetail profile={selectedProfile} onBack={() => { setView('list'); setSelectedProfile(null); }} onEdit={() => setView('edit')} onDelete={() => setProfileToDelete(selectedProfile)} onExportPDF={handleExportPDF} onGenerateDescription={() => setShowGenerator(true)} userRole={userRole} />
                    </>
                );
            }

            return (
                <div>
                    {profileToDelete && <ConfirmationModal message={`¿Seguro que quieres eliminar la ficha de ${profileToDelete.nombre_apellidos}?`} onConfirm={handleDeleteConfirm} onCancel={() => setProfileToDelete(null)} />}
                    <div className="phase-header">
                        <h2>Gestión de Empleados</h2>
                        <p>Busca, visualiza y añade nuevas fichas de puesto de trabajo.</p>
                    </div>
                    <div className="subsection flex flex-col md:flex-row justify-between items-center gap-4">
                        <input type="text" placeholder="Buscar por nombre o puesto..." className="form-input w-full md:flex-grow" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <div><button onClick={() => setView('create')} className="btn-action w-full md:w-auto">Añadir Ficha</button></div>
                    </div>
                    <div className="subsection">
                        <h3>Fichas de Puesto Creadas</h3>
                        {filteredProfiles.length > 0 ? (
                            <div className="overflow-x-auto">
                                <table className="min-w-full bg-white">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Puesto</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departamento</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aprobado</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {filteredProfiles.map(profile => (
                                            <tr key={profile.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => { setSelectedProfile(profile); setView('detail'); }}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">{profile.id}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">{profile.nombre_apellidos}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{profile.nombre_puesto}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">{profile.departamento}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <label className="flex items-center" onClick={(e) => e.stopPropagation()}>
                                                        <div className="relative">
                                                            <input type="checkbox" className="sr-only" checked={profile.approved} onChange={() => handleToggleApprove(profile)} />
                                                            <div className={`block w-10 h-6 rounded-full ${profile.approved ? 'bg-blue-600' : 'bg-gray-200'}`}></div>
                                                            <div className={`dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform ${profile.approved ? 'transform translate-x-4' : ''}`}></div>
                                                        </div>
                                                    </label>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                                    {userRole === 'admin' && (<button onClick={(e) => {e.stopPropagation(); setProfileToDelete(profile);}} className="btn-danger p-2"><TrashIcon /></button>)}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : <p className="mt-4 text-gray-500">No se encontraron fichas. ¡Añade una para empezar!</p>}
                    </div>
                </div>
            );
        };

        // --- USER PROFILE & DASHBOARD COMPONENTS ---
        const ProfileDropdown = ({ user, loginTime, showNotification, onSettingsClick, onExportAll }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [showContactForm, setShowContactForm] = useState(false);
            const [contactSubject, setContactSubject] = useState('');
            const [contactMessage, setContactMessage] = useState('');
            const [elapsedTime, setElapsedTime] = useState('00:00:00');
            const dropdownRef = useRef(null);

            useEffect(() => {
                const timer = setInterval(() => {
                    const seconds = Math.floor((Date.now() - loginTime) / 1000);
                    const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
                    const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                    const s = String(seconds % 60).padStart(2, '0');
                    setElapsedTime(`${h}:${m}:${s}`);
                }, 1000);
                return () => clearInterval(timer);
            }, [loginTime]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                        setShowContactForm(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [dropdownRef]);
            
            const handleSendEmail = (e) => {
                e.preventDefault();
                window.location.href = `mailto:hacchi.creativiza@gmail.com?subject=${encodeURIComponent(contactSubject)}&body=${encodeURIComponent(contactMessage)}`;
                showNotification('Abriendo cliente de correo...', 'success');
                setIsOpen(false);
                setShowContactForm(false);
            };

            return (
                <div className="relative" ref={dropdownRef}>
                    <button onClick={() => setIsOpen(!isOpen)} className="p-2 rounded-full hover:bg-gray-200"><UserIcon /></button>
                    {isOpen && (
                        <div className="absolute right-0 mt-2 w-72 bg-white rounded-md shadow-lg z-20 border">
                            <div className="p-4">
                                {showContactForm ? (
                                    <div>
                                        <h4 className="font-bold mb-2">Enviar Consulta</h4>
                                        <form onSubmit={handleSendEmail}>
                                            <input type="text" placeholder="Asunto" className="form-input mb-2" value={contactSubject} onChange={e => setContactSubject(e.target.value)} required />
                                            <textarea placeholder="Tu mensaje..." className="form-textarea mb-2" style={{minHeight: '100px'}} value={contactMessage} onChange={e => setContactMessage(e.target.value)} required></textarea>
                                            <div className="flex justify-end gap-2">
                                                <button type="button" onClick={() => setShowContactForm(false)} className="btn-secondary text-sm">Cancelar</button>
                                                <button type="submit" className="btn-action text-sm">Enviar</button>
                                            </div>
                                        </form>
                                    </div>
                                ) : (
                                    <>
                                        <div className="border-b pb-2 mb-2">
                                            <p className="font-semibold text-sm truncate">{user.email}</p>
                                            <p className="text-xs text-gray-500">Miembro</p>
                                        </div>
                                        <div className="text-xs text-gray-500 mb-3"><p>Tiempo de conexión: {elapsedTime}</p></div>
                                        <button onClick={onSettingsClick} className="w-full text-left text-sm p-2 rounded hover:bg-gray-100 flex items-center gap-2"><SettingsIcon /> Configuración</button>
                                        <button onClick={onExportAll} className="w-full text-left text-sm p-2 rounded hover:bg-gray-100 flex items-center gap-2"><DownloadIcon /> Exportar Todo a PDF</button>
                                        <button onClick={() => setShowContactForm(true)} className="w-full text-left text-sm p-2 rounded hover:bg-gray-100">Enviar Consulta</button>
                                        <button onClick={() => supabaseClient.auth.signOut()} className="w-full text-left text-sm p-2 rounded hover:bg-gray-100 text-red-600">Cerrar Sesión</button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        const DashboardSection = ({ jobProfiles, progress, onNavigate, activityLog, setProfileToEdit, onResetLog, studyData }) => {
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const StatCard = ({ title, value }) => (
                <div className="bg-white p-4 rounded-lg shadow">
                    <p className="text-sm text-gray-500">{title}</p>
                    <p className="text-2xl font-bold my-1">{value}</p>
                </div>
            );
            const NuevasAltas = ({ profiles }) => {
                const handleRowClick = (profile) => {
                    setProfileToEdit(profile);
                    onNavigate('empleados');
                };
                return (
                    <div className="bg-white p-4 rounded-lg shadow">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold">Nuevas Altas</h3>
                            <button onClick={() => onNavigate('empleados')} className="text-sm text-blue-600 hover:underline">Ver todas</button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="min-w-full w-full text-sm text-left">
                                <thead><tr className="border-b-2 border-gray-100"><th className="px-4 py-3 font-semibold text-gray-600">ID</th><th className="px-4 py-3 font-semibold text-gray-600">Nombre</th><th className="px-4 py-3 font-semibold text-gray-600">Puesto</th><th className="px-4 py-3 font-semibold text-gray-600">Condición</th></tr></thead>
                                <tbody>
                                    {profiles.slice(0, 5).map((p) => (
                                        <tr key={p.id} className="border-b border-gray-100 hover:bg-gray-50 cursor-pointer" onClick={() => handleRowClick(p)}>
                                            <td className="px-4 py-3 text-blue-600 font-medium">{p.id}</td>
                                            <td className="px-4 py-3 font-bold text-gray-800">{p.nombre_apellidos}</td>
                                            <td className="px-4 py-3 text-gray-600">{p.nombre_puesto}</td>
                                            <td className="px-4 py-3"><span className={`text-xs font-semibold px-2 py-1 rounded-full ${p.approved ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{p.approved ? 'Aprobado' : 'Pendiente'}</span></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {profiles.length === 0 && <p className="text-sm text-gray-500 text-center py-4">No hay nuevas altas registradas.</p>}
                        </div>
                    </div>
                );
            };
            const ActivityLog = ({ log, onReset }) => {
                const timeAgo = (date) => {
                    if (!date) return '';
                    const seconds = Math.floor((new Date() - new Date(date)) / 1000);
                    let interval = seconds / 31536000; if (interval > 1) return `hace ${Math.floor(interval)} años`;
                    interval = seconds / 2592000; if (interval > 1) return `hace ${Math.floor(interval)} meses`;
                    interval = seconds / 86400; if (interval > 1) return `hace ${Math.floor(interval)} días`;
                    interval = seconds / 3600; if (interval > 1) return `hace ${Math.floor(interval)} horas`;
                    interval = seconds / 60; if (interval > 1) return `hace ${Math.floor(interval)} minutos`;
                    return `hace unos segundos`;
                };
                return (
                     <div className="bg-white p-4 rounded-lg shadow h-full">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold">Registro de Actividad</h3><button onClick={onReset} className="p-1 hover:bg-gray-200 rounded-full" title="Borrar registro"><TrashIcon /></button></div>
                        <ul className="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                            {log.map((item) => (
                                <li key={item.id} className="flex items-start">
                                    <div className="flex-shrink-0 h-6 w-6 rounded-full bg-gray-200 flex items-center justify-center mr-3 mt-1"><svg className="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                                    <div><p className="text-sm font-medium">{item.action}</p><p className="text-xs text-gray-500">{timeAgo(item.created_at)}</p></div>
                                </li>
                            ))}
                             {log.length === 0 && <p className="text-sm text-gray-500 text-center py-4">No hay actividad registrada.</p>}
                        </ul>
                    </div>
                );
            };
            return (
                <>
                {showResetConfirm && <ConfirmationModal message="¿Seguro que quieres borrar todo el registro de actividad?" onConfirm={() => { onResetLog(); setShowResetConfirm(false); }} onCancel={() => setShowResetConfirm(false)} />}
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard title="Total Empleados" value={jobProfiles.length} />
                        <StatCard title="Progreso General" value={`${Math.round(progress)}%`} />
                        <StatCard title="Fichas Aprobadas" value={jobProfiles.filter(p => p.approved).length} />
                        <StatCard title="Fases del Estudio" value={studyData.filter(p => p.id.startsWith('phase')).length} />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2"><NuevasAltas profiles={jobProfiles} /></div>
                        <div className="lg:col-span-1"><ActivityLog log={activityLog} onReset={() => setShowResetConfirm(true)} /></div>
                    </div>
                </div>
                </>
            );
        };
        
        const PhaseSummary = ({ phase, allTasks, showNotification, user, summaryData, onSummaryUpdate, aiModel, openaiApiKey }) => {
            const [isLoading, setIsLoading] = useState(false);
            const phaseTaskIds = phase.sections?.flatMap(s => s.tasks || []) || [];
            const phaseTasks = allTasks.filter(t => phaseTaskIds.includes(t.task_id));
            const canTakeAction = phaseTasks.length > 0 && phaseTasks.some(t => t.status === 'aprobado');

            const handleGenerateSummary = async () => {
                if (!openaiApiKey) { showNotification('La clave de API de OpenAI no está configurada.', 'error'); return; }
                setIsLoading(true);
                const taskNotes = phaseTasks.filter(t => t.status === 'aprobado' && t.notes).map(t => `Tarea: ${t.task_id}\nNotas: ${t.notes.replace(PARADO_TAG, '').trim()}`).join('\n\n');
                const prompt = `Eres un consultor de organización. Analiza la siguiente información de una fase de un estudio y genera un resumen contextual. Explica el estado actual, los puntos clave y las posibles implicaciones.
                    Fase: ${phase.title} - Descripción: ${phase.sections[0]?.description || ''}
                    Datos de las tareas aprobadas:
                    ${taskNotes || 'No hay notas en las tareas aprobadas.'}
                    Proporciona un resumen coherente y profesional en español.`;

                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiApiKey}` },
                        body: JSON.stringify({ model: aiModel, messages: [{ role: 'system', content: 'Eres un consultor de organización de empresas.' }, { role: 'user', content: prompt }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    const generatedText = data.choices[0].message.content;
                    const { error } = await supabaseClient.from('phase_summaries').upsert({ phase_id: phase.id, user_id: user.id, summary_text: generatedText }, { onConflict: 'phase_id, user_id' });
                    if (error) throw error;
                    showNotification('Resumen generado y guardado.', 'success');
                    onSummaryUpdate();
                } catch (err) {
                    showNotification(`Error al generar resumen: ${err.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const handleDeleteSummary = async () => {
                setIsLoading(true);
                try {
                    const { error } = await supabaseClient.from('phase_summaries').delete().match({ phase_id: phase.id, user_id: user.id });
                    if (error) throw error;
                    showNotification('Resumen eliminado.', 'success');
                    onSummaryUpdate();
                } catch (err) {
                    showNotification(`Error al eliminar: ${err.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="subsection mt-6 border-t-4 border-blue-200">
                    <h3 className="text-lg font-bold">Resumen de Fase con IA</h3>
                    <div className="mt-4">
                        <div className="flex flex-wrap gap-4">
                            <button onClick={handleGenerateSummary} className="btn-success" disabled={!canTakeAction || isLoading}>{isLoading ? <LoaderIcon /> : <SparklesIcon />}{isLoading ? 'Procesando...' : 'Generar / Actualizar'}</button>
                            <button onClick={handleDeleteSummary} className="btn-danger" disabled={isLoading || !summaryData}>{isLoading ? <LoaderIcon /> : <TrashIcon />}{'Eliminar'}</button>
                        </div>
                        {!canTakeAction && <p className="text-sm text-gray-500 mt-3">Aprueba al menos una tarea para poder generar un resumen.</p>}
                        {summaryData && summaryData.summary_text && (
                            <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
                                <h4 className="font-bold mb-2">Resumen Guardado:</h4>
                                <p className="text-sm whitespace-pre-wrap">{summaryData.summary_text}</p>
                                <p className="text-xs text-gray-500 mt-2">Última actualización: {new Date(summaryData.created_at).toLocaleString()}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const SummariesSection = ({ phaseSummaries, showNotification, aiModel, openaiApiKey, studyData }) => {
            const [isLoading, setIsLoading] = useState(false);
            const [generalSummary, setGeneralSummary] = useState('');
            const summaryTextAreaRef = useRef(null);
            useAutosizeTextArea(summaryTextAreaRef, generalSummary);

            const handleGenerateGeneralSummary = async () => {
                if (!openaiApiKey) { showNotification('La clave de API de OpenAI no está configurada.', 'error'); return; }
                if (phaseSummaries.length === 0) { showNotification("No hay resúmenes de fase para analizar.", 'warning'); return; }
                setIsLoading(true);
                setGeneralSummary('');
                const summariesText = phaseSummaries.map(s => {
                    const phaseTitle = studyData.find(p => p.id === s.phase_id)?.title || s.phase_id;
                    return `**${phaseTitle}**:\n${s.summary_text}`;
                }).join('\n\n');
                const prompt = `Eres un consultor de alta dirección. Sintetiza los siguientes resúmenes de fase de un estudio organizativo en un único Resumen Ejecutivo final.
                    El resumen debe:
                    1. Integrar los hallazgos clave en una narrativa coherente.
                    2. Identificar temas recurrentes.
                    3. Concluir con 3-4 recomendaciones estratégicas de alto nivel.
                    **Resúmenes de Fase para Analizar:**
                    ${summariesText}
                    Genera el Resumen Ejecutivo final en español, con un tono profesional y directo.`;
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiApiKey}` },
                        body: JSON.stringify({ model: aiModel, messages: [{ role: 'system', content: 'Eres un consultor de alta dirección.' }, { role: 'user', content: prompt }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    setGeneralSummary(data.choices[0].message.content);
                    showNotification('Resumen general generado.', 'success');
                } catch (err) {
                    showNotification(`Error al generar resumen general: ${err.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="subsection">
                    <h2 className="text-xl font-bold mb-4">Resumen General del Estudio</h2>
                    <div className="mb-6">
                        <h3 className="font-bold text-lg mb-2">Resúmenes de Fase Acumulados</h3>
                        {phaseSummaries && phaseSummaries.length > 0 ? (
                            <ul className="space-y-4">
                                {phaseSummaries.map(summary => {
                                    const phase = studyData.find(p => p.id === summary.phase_id);
                                    return (
                                        <li key={summary.id} className="p-4 border rounded-lg bg-gray-50">
                                            <h4 className="font-bold text-md text-blue-700">{phase ? phase.title : 'Fase Desconocida'}</h4>
                                            <p className="text-sm text-gray-800 mt-2 whitespace-pre-wrap">{summary.summary_text}</p>
                                        </li>
                                    );
                                })}
                            </ul>
                        ) : <p className="text-sm text-gray-500">Aún no se ha generado ningún resumen de fase.</p>}
                    </div>
                    <div className="border-t pt-6">
                         <h3 className="font-bold text-lg mb-2">Resumen Ejecutivo Final (IA)</h3>
                        <div className="p-4 border-2 border-dashed border-gray-300 rounded-md mt-2 min-h-[200px] flex items-center justify-center">
                            {isLoading ? (
                                <div className="text-center"><LoaderIcon /><p className="mt-2 text-gray-600">Generando resumen...</p></div>
                            ) : generalSummary ? (
                                <textarea ref={summaryTextAreaRef} readOnly className="notes-textarea w-full p-2 bg-gray-50" value={generalSummary} />
                            ) : <p className="text-gray-500 text-center">Haz clic en el botón para generar un resumen ejecutivo.</p>}
                        </div>
                        <div className="flex justify-end mt-4">
                            <button onClick={handleGenerateGeneralSummary} className="btn-action" disabled={isLoading}>{isLoading ? <LoaderIcon /> : <SparklesIcon />}{isLoading ? 'Generando...' : 'Actualizar Resumen General'}</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const Organigrama = ({ jobProfiles, onEditProfile }) => {
            const [nodes, setNodes] = useState([]);
            const [openNodes, setOpenNodes] = useState({});
            const orgChartRef = useRef(null);

            useEffect(() => {
                const buildTree = (profiles) => {
                    if (!profiles || profiles.length === 0) return [];
                    const puestoMap = new Map();
                    profiles.forEach(profile => {
                        if (!puestoMap.has(profile.nombre_puesto)) {
                             puestoMap.set(profile.nombre_puesto, { id: profile.nombre_puesto, nombre_puesto: profile.nombre_puesto, departamento: profile.departamento, reporta_a: profile.reporta_a, empleados: [], children: [] });
                        }
                        puestoMap.get(profile.nombre_puesto).empleados.push(profile);
                    });
                    const tree = [];
                    puestoMap.forEach(puestoNode => {
                        if (puestoNode.reporta_a && puestoMap.has(puestoNode.reporta_a)) {
                            puestoMap.get(puestoNode.reporta_a).children.push(puestoNode);
                        } else {
                            tree.push(puestoNode);
                        }
                    });
                    return tree;
                };
                setNodes(buildTree(jobProfiles));
            }, [jobProfiles]);

            const handlePrint = () => window.print();
            const toggleNodeDescription = (nodeId) => setOpenNodes(prev => ({ ...prev, [nodeId]: !prev[nodeId] }));

            const OrgNode = ({ node }) => {
                const isOpen = !!openNodes[node.id];
                const hasChildren = node.children && node.children.length > 0;
                return (
                    <li>
                        <div className={`org-node ${isOpen ? 'is-open' : ''} ${!hasChildren ? 'no-children' : ''}`}>
                            <div className="node-header" onClick={() => toggleNodeDescription(node.id)}>
                                <div>
                                    <p className="node-role">{node.nombre_puesto}</p>
                                    <p className="node-department">{node.departamento}</p>
                                </div>
                                <span className="toggle-button">›</span>
                            </div>
                             <div className="node-description">
                                {node.empleados.map(emp => (
                                    <div key={emp.id} className="my-2">
                                        <p className="font-semibold">{emp.nombre_apellidos}</p>
                                        <p className="text-xs text-gray-600 mt-1">{emp.proposito || 'Sin descripción de propósito.'}</p>
                                        <button onClick={() => onEditProfile(emp.id)} className="text-xs text-blue-500 hover:underline mt-1">Ver/Editar Ficha</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                        {hasChildren && <ul>{node.children.map(child => <OrgNode key={child.id} node={child} />)}</ul>}
                    </li>
                );
            };

            if (jobProfiles.length === 0) {
                return (
                    <div className="subsection text-center">
                        <h2 className="text-xl font-bold mb-4">Organigrama de la Empresa</h2>
                        <p>No hay fichas de empleados para generar el organigrama. Añade una para empezar.</p>
                    </div>
                );
            }

            return (
                <div className="subsection">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold">Organigrama de la Empresa</h2>
                        <button onClick={handlePrint} className="btn-action btn-print-org"><DownloadIcon /> Imprimir Organigrama</button>
                    </div>
                    <div className="org-chart-dynamic" ref={orgChartRef}><ul>{nodes.map(node => <OrgNode key={node.id} node={node} />)}</ul></div>
                </div>
            );
        };

        const EmployeeFooter = () => {
            return (
                <footer style={{ position: 'fixed', bottom: 0, left: 0, width: '100%', padding: '20px', backgroundColor: 'var(--background-white)', textAlign: 'center', boxShadow: '0 -2px 5px rgba(0,0,0,0.1)', zIndex: 1000 }}>
                    <button onClick={() => supabaseClient.auth.signOut()} className="btn-danger">Cerrar Sesión</button>
                </footer>
            );
        };

        // --- CORE APP LOGIC COMPONENT ---
        const EstudioApp = ({ user }) => {
            const [studyData, setStudyData] = useState([]);
            const [allTaskIds, setAllTaskIds] = useState([]);
            const [dataLoading, setDataLoading] = useState(true);

            useEffect(() => {
                const fetchStudyData = async () => {
                    setDataLoading(true);
                    const { data, error } = await supabaseClient.from('study_phases').select('*').order('created_at', { ascending: true });
                    if (error) {
                        console.error('Error fetching study data:', error);
                        setStudyData([]);
                    } else {
                        setStudyData(data || []);
                        const taskIds = (data || []).flatMap(phase => phase.sections?.flatMap(section => section.tasks || []) || []).filter(Boolean);
                        setAllTaskIds(taskIds);
                    }
                    setDataLoading(false);
                };
                fetchStudyData();
            }, []);

            const [activeSection, setActiveSection] = useState('dashboard');
            const [tasks, setTasks] = useState([]);
            const [jobProfiles, setJobProfiles] = useState([]);
            const [activityLog, setActivityLog] = useState([]);
            const [phaseSummaries, setPhaseSummaries] = useState([]);
            const [notification, setNotification] = useState({ show: false, message: '', type: '' });
            const [openaiApiKey, setOpenaiApiKey] = useState('');
            const [aiModel, setAiModel] = useState('gpt-3.5-turbo');
            const [isRecording, setIsRecording] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const mediaRecorder = useRef(null);
            const [activeTaskId, setActiveTaskId] = useState(null);
            const [loginTime] = useState(Date.now());
            const [showSettings, setShowSettings] = useState(false);
            const [userRole, setUserRole] = useState('employee');
            const [loadingRole, setLoadingRole] = useState(true);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [profileToEdit, setProfileToEdit] = useState(null);
            
            const PREDEFINED_OPTIONS = {
                puestos: [ "Director Producción", "Jefe Almacén", "Jefe Taller", "Tapicero", "Encargado de tapiceria", "Carpintero", "Encargada de confección", "Especialista en Confección", "Especialista confección y acabado", "Oficial de 1ª", "Oficial de 2ª", "Director Financiero", "Jefe administración", "RRHH", "Proveedores", "Facturación", "Recobro", "Contable", "Director operaciones", "Jefe ventas", "Comerciales", "Comercial Madera", "Gestores Nacional", "Gestores Internacional", "Recepción", "Responsable de obra", "Jefe de obra", "Peon", "Propiedad" ],
                departamentos: [ "Directiva", "Producción", "Administracion", "Comercial" ],
                reporta_a: [ "Director Producción", "Jefe Almacén", "Jefe Taller", "Tapicero", "Encargado de tapiceria", "Carpintero", "Encargada de confección", "Especialista en Confección", "Especialista confección y acabado", "Oficial de 1ª", "Oficial de 2ª", "Director Financiero", "Jefe administración", "RRHH", "No necesita" ],
                tipos_contrato: [ "Temporal", "Fijo Discontinuo", "FiJo", "Subcontrata" ],
                modalidades_trabajo: [ "Presencial", "A distancia", "Hibrido" ]
            };

            const showNotification = (message, type = 'success') => {
                setNotification({ show: true, message, type });
                setTimeout(() => setNotification({ show: false, message: '', type: '' }), 4000);
            };

            const fetchUserRole = useCallback(async () => {
                const { data, error } = await supabaseClient.rpc('get_my_role');
                if (error || !data) {
                    setUserRole('employee');
                } else {
                    setUserRole(data);
                }
                setLoadingRole(false);
            }, [user.id]);

            const fetchActivityLog = useCallback(async () => {
                const { data, error } = await supabaseClient.from('activity_log').select('*').order('created_at', { ascending: false }).limit(50);
                if (!error) setActivityLog(data || []);
            }, []);
            
            const fetchPhaseSummaries = useCallback(async () => {
                const { data, error } = await supabaseClient.from('phase_summaries').select('*').eq('user_id', user.id);
                if (!error) setPhaseSummaries(data || []);
            }, [user.id]);

            const logActivity = async (action) => {
                const { error } = await supabaseClient.from('activity_log').insert([{ action, user_id: user.id }]);
                if (!error) fetchActivityLog();
            };
            
            const handleResetLog = async () => {
                if(userRole !== 'admin') { showNotification('No tienes permiso para esta acción.', 'error'); return; }
                const { error } = await supabaseClient.from('activity_log').delete().gt('id', 0);
                if (error) { showNotification('Error al borrar el registro.', 'error'); }
                else { setActivityLog([]); showNotification('Registro de actividad borrado.', 'success'); }
            };

            const fetchInitialData = useCallback(async () => {
                await fetchUserRole();
                const { data: tasksData } = await supabaseClient.from('tasks').select('task_id, is_completed, notes');
                const taskMap = new Map((tasksData || []).map(task => [task.task_id, task]));
                setTasks(allTaskIds.map(id => {
                    const dbTask = taskMap.get(id);
                    let status = 'pendiente';
                    if (dbTask) {
                        if (dbTask.is_completed) status = 'aprobado';
                        else if (dbTask.notes?.includes(PARADO_TAG)) status = 'parado';
                    }
                    return { task_id: id, user_id: user.id, notes: dbTask?.notes || '', status: status, is_editing: false };
                }));
                const { data: profilesData } = await supabaseClient.from('job_profiles').select('*').order('created_at', { ascending: false });
                setJobProfiles(profilesData || []);
                const { data: profileData } = await supabaseClient.from('profiles').select('openai_api_key').eq('id', user.id).single();
                if (profileData) setOpenaiApiKey(profileData.openai_api_key || '');
                await fetchActivityLog();
                await fetchPhaseSummaries();
            }, [user.id, allTaskIds, fetchUserRole, fetchActivityLog, fetchPhaseSummaries]);

            useEffect(() => {
                if (!dataLoading) { fetchInitialData(); }
            }, [fetchInitialData, dataLoading]);

            useEffect(() => {
                if(!loadingRole) {
                    setActiveSection(userRole === 'employee' ? 'empleados' : 'dashboard');
                }
            }, [userRole, loadingRole]);

            const getTaskState = useCallback((taskId) => tasks.find(t => t.task_id === taskId) || { status: 'pendiente', notes: '', is_editing: false }, [tasks]);
            
            const updateTask = async (taskId, newState, showSuccess = true) => {
                const mergedState = { ...getTaskState(taskId), ...newState };
                let notes = (mergedState.notes || '').replace(PARADO_TAG, '').trim();
                if (mergedState.status === 'parado') notes = `${PARADO_TAG} ${notes}`.trim();
                const { data, error } = await supabaseClient.from('tasks').upsert({ user_id: user.id, task_id: taskId, is_completed: mergedState.status === 'aprobado', notes }, { onConflict: 'user_id, task_id' }).select().single();
                if (error) { showNotification(`Error al guardar: ${error.message}`, 'error'); }
                else {
                    if (showSuccess) showNotification(newState.status ? 'Estado actualizado.' : 'Notas guardadas.', 'success');
                    setTasks(prev => prev.map(t => t.task_id === taskId ? { ...t, ...mergedState, notes: data.notes } : t));
                }
            };
            
            const handleToggleEditTask = (taskId, isEditing) => setTasks(prev => prev.map(t => t.task_id === taskId ? { ...t, is_editing: isEditing } : t));
            
            const handleSaveSettings = async (settings) => {
                setAiModel(settings.aiModel);
                setOpenaiApiKey(settings.openaiApiKey);
                const { error } = await supabaseClient.from('profiles').update({ openai_api_key: settings.openaiApiKey }).eq('id', user.id);
                showNotification(error ? `Error: ${error.message}` : 'Configuración guardada.', error ? 'error' : 'success');
                setShowSettings(false);
            };

            const handleRecording = async (taskId) => {
                if (isRecording) { mediaRecorder.current?.stop(); return; }
                if (!openaiApiKey) { showNotification('Configura tu clave de API de OpenAI en Ajustes.', 'error'); return; }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    setIsRecording(true);
                    setActiveTaskId(taskId);
                    mediaRecorder.current = new MediaRecorder(stream);
                    const audioChunks = [];
                    mediaRecorder.current.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.current.onstop = async () => {
                        stream.getTracks().forEach(track => track.stop());
                        setIsRecording(false);
                        setIsProcessing(true);
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        if (audioBlob.size === 0) { setIsProcessing(false); setActiveTaskId(null); return; }
                        const formData = new FormData();
                        formData.append('file', audioBlob, 'recording.webm');
                        formData.append('model', 'whisper-1');
                        try {
                            const res = await fetch('https://api.openai.com/v1/audio/transcriptions', { method: 'POST', headers: { Authorization: `Bearer ${openaiApiKey}` }, body: formData });
                            const data = await res.json();
                            if (data.error) throw new Error(data.error.message);
                            const currentNotes = getTaskState(taskId).notes.replace(PARADO_TAG, '').trim() || '';
                            await updateTask(taskId, { notes: `${currentNotes}\n${data.text}`.trim() });
                        } catch (error) { showNotification(`Error de transcripción: ${error.message}`, 'error'); } 
                        finally { setIsProcessing(false); setActiveTaskId(null); }
                    };
                    mediaRecorder.current.start();
                } catch(err) {
                    showNotification('No se pudo acceder al micrófono.', 'error');
                    setIsRecording(false);
                    setActiveTaskId(null);
                }
            };

            const handleGenerateSummary = async (taskId) => {
                const task = getTaskState(taskId);
                const notesToSummarize = task.notes.replace(PARADO_TAG, '').split('--- Resumen IA ---')[0].trim();
                if (!notesToSummarize) { showNotification('No hay notas para resumir.', 'error'); return; }
                if (!openaiApiKey) { showNotification('Configura tu clave de API de OpenAI en Ajustes.', 'error'); return; }
                setIsProcessing(true);
                setActiveTaskId(taskId);
                try {
                    const res = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiApiKey}` },
                        body: JSON.stringify({ model: aiModel, messages: [{ role: 'user', content: `Resume el siguiente texto de forma concisa en español: ${notesToSummarize}` }] })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error.message);
                    await updateTask(taskId, { notes: `${notesToSummarize}\n\n--- Resumen IA ---\n${data.choices[0].message.content}` });
                } catch (error) { showNotification(`Error al generar resumen: ${error.message}`, 'error'); } 
                finally { setIsProcessing(false); setActiveTaskId(null); }
            };
            
            const handleExportAllToPDF = () => {
                logActivity('Iniciada exportación a PDF de todo el informe');
                const pdf = new jsPDF('p', 'mm', 'a4');
                let y = 20;
                const pageHeight = 297, margin = 15, contentWidth = 210 - (2 * margin);
                const checkPageBreak = (currentY, requiredHeight) => {
                    if (currentY + requiredHeight > pageHeight - margin) {
                        pdf.addPage();
                        return margin;
                    }
                    return currentY;
                };
                pdf.setFontSize(22).setFont("helvetica", "bold").setTextColor(40, 40, 40).text("Informe del Estudio Organizativo", 105, y, { align: 'center' });
                y += 8;
                pdf.setFontSize(14).setFont("helvetica", "normal").setTextColor(100, 100, 100).text("EGEA Dev", 105, y, { align: 'center' });
                y += 12;
                pdf.setFontSize(16).setFont("helvetica", "bold").text("Resumen General", margin, y);
                y += 8;
                const progress = allTaskIds.length > 0 ? Math.round((tasks.filter(t => t.status === 'aprobado').length / allTaskIds.length) * 100) : 0;
                pdf.setFontSize(11).setFont("helvetica", "normal").text(`- Progreso Total del Estudio: ${progress}%`, margin + 5, y);
                y += 7;
                pdf.text(`- Fichas de Empleado Registradas: ${jobProfiles.length}`, margin + 5, y);
                y += 15;
                studyData.filter(p => p.id.startsWith('phase')).forEach(phase => {
                    y = checkPageBreak(y, 20);
                    pdf.setFontSize(14).setFont("helvetica", "bold").setTextColor(0, 121, 191).text(phase.title, margin, y);
                    y += 8;
                    phase.sections.forEach(section => {
                        section.tasks?.forEach(taskId => {
                            const taskState = getTaskState(taskId);
                            const statusSymbol = { pendiente: '○', parado: '✗', aprobado: '✓' };
                            const taskLines = pdf.splitTextToSize(`${statusSymbol[taskState.status]} ${taskId}`, contentWidth - 8);
                            y = checkPageBreak(y, taskLines.length * 5);
                            pdf.setFontSize(10).setFont("helvetica", "normal").setTextColor(50, 50, 50).text(taskLines, margin + 5, y);
                            y += taskLines.length * 5;
                        });
                    });
                });
                pdf.save(`informe-egea-${new Date().toISOString().slice(0,10)}.pdf`);
            };

            const SettingsModal = ({ onClose, onSave, initialSettings }) => {
                const [localOpenaiKey, setLocalOpenaiKey] = useState(initialSettings.openaiApiKey);
                const [localAiModel, setLocalAiModel] = useState(initialSettings.aiModel);
                return (
                    <div className="modal-overlay">
                        <div className="modal-content">
                            <h3 className="text-lg font-bold mb-4">Configuración de IA</h3>
                             <div>
                                <label className="form-label">Modelo de IA (Texto)</label>
                                <select className="form-select" value={localAiModel} onChange={e => setLocalAiModel(e.target.value)}>
                                    <option value="gpt-4">OpenAI (GPT-4)</option>
                                    <option value="gpt-3.5-turbo">OpenAI (GPT-3.5)</option>
                                </select>
                            </div>
                            <div>
                                <label className="form-label">Clave de API de OpenAI</label>
                                <input type="password" placeholder="sk-..." value={localOpenaiKey} onChange={e => setLocalOpenaiKey(e.target.value)} className="form-input" />
                            </div>
                            <div className="flex justify-end gap-2 mt-6">
                                <button onClick={onClose} className="btn-secondary">Cancelar</button>
                                <button onClick={() => onSave({ openaiApiKey: localOpenaiKey, aiModel: localAiModel })} className="btn-action">Guardar</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // **LA SOLUCIÓN CLAVE ESTÁ AQUÍ**
            // Se muestra un loader hasta que los datos esenciales (rol y fases) se hayan cargado.
            if (loadingRole || dataLoading) {
                return <div className="flex justify-center items-center h-screen"><LoaderIcon /></div>;
            }

            const getVisibleNavItems = () => {
                if (userRole === 'admin') return studyData;
                if (userRole === 'management') return studyData.filter(p => p.id === 'dashboard' || p.id === 'summaries');
                return [];
            };
            
            const handleEditProfileFromChart = (profileId) => {
                const profile = jobProfiles.find(p => p.id === profileId);
                if (profile) {
                    setProfileToEdit(profile);
                    setActiveSection('empleados');
                }
            };

            const progress = allTaskIds.length > 0 ? (tasks.filter(t => t.status === 'aprobado').length / allTaskIds.length) * 100 : 0;

            return (
                <>
                    {notification.show && <div className={`notification ${notification.type}`}>{notification.message}</div>}
                    {showSettings && <SettingsModal onClose={() => setShowSettings(false)} onSave={handleSaveSettings} initialSettings={{ openaiApiKey, aiModel }} />}
                    <div className="container">
                        {userRole !== 'employee' && (
                            <div className="header">
                                <div className="header-title"><h1>EGEA Dev</h1><p>Estudio Organizativo</p></div>
                                <div className="flex items-center gap-4">
                                    <ProfileDropdown user={user} loginTime={loginTime} showNotification={showNotification} onSettingsClick={() => setShowSettings(true)} onExportAll={handleExportAllToPDF} />
                                    <div className="md:hidden"><button onClick={() => setIsMenuOpen(!isMenuOpen)} className="p-2">{isMenuOpen ? <XIcon /> : <MenuIcon />}</button></div>
                                </div>
                            </div>
                        )}
                        
                        {userRole !== 'employee' && (
                             <nav className={`navigation ${isMenuOpen ? 'flex-col items-start' : 'hidden'} md:flex md:flex-row md:items-center`}>
                                {getVisibleNavItems().map(phase => (
                                    <button key={phase.id} className={`nav-btn w-full md:w-auto text-left ${activeSection === phase.id ? 'active' : ''}`} onClick={() => {setActiveSection(phase.id); setIsMenuOpen(false);}}>{phase.title}</button>
                                ))}
                                {(userRole === 'admin' || userRole === 'management') && (
                                    <>
                                        <button className={`nav-btn w-full md:w-auto text-left ${activeSection === 'empleados' ? 'active' : ''}`} onClick={() => {setActiveSection('empleados'); setIsMenuOpen(false);}}>Empleados</button>
                                        <button className={`nav-btn w-full md:w-auto text-left ${activeSection === 'organigrama' ? 'active' : ''}`} onClick={() => {setActiveSection('organigrama'); setIsMenuOpen(false);}}>Organigrama</button>
                                    </>
                                )}
                            </nav>
                        )}

                        <div className={`content-section ${activeSection === 'dashboard' ? 'active' : ''}`}>
                            <DashboardSection jobProfiles={jobProfiles} progress={progress} onNavigate={setActiveSection} activityLog={activityLog} setProfileToEdit={setProfileToEdit} onResetLog={handleResetLog} studyData={studyData} />
                        </div>
                        <div className={`content-section ${activeSection === 'summaries' ? 'active' : ''}`}>
                            <SummariesSection phaseSummaries={phaseSummaries} showNotification={showNotification} aiModel={aiModel} openaiApiKey={openaiApiKey} studyData={studyData} />
                        </div>
                        {studyData.filter(p => p.id.startsWith('phase')).map(phase => (
                            <div key={phase.id} className={`content-section ${activeSection === phase.id ? 'active' : ''}`}>
                                {phase.sections?.map((section, idx) => (
                                    <div key={idx} className="subsection">
                                        {section.description && <p className="mb-4 text-gray-600">{section.description}</p>}
                                        {section.tasks && <ul className="checklist">{section.tasks.map(taskId => <TaskItem key={taskId} taskId={taskId} taskState={getTaskState(taskId)} onStatusChange={updateTask} onNoteChange={updateTask} onRecord={{handle: handleRecording, isRecording, isProcessing, activeTaskId}} onSummarize={handleGenerateSummary} onEditClick={handleToggleEditTask} />)}</ul>}
                                    </div>
                                ))}
                                <PhaseSummary phase={phase} allTasks={tasks} showNotification={showNotification} user={user} summaryData={phaseSummaries.find(s => s.phase_id === phase.id)} onSummaryUpdate={fetchPhaseSummaries} aiModel={aiModel} openaiApiKey={openaiApiKey} />
                            </div>
                        ))}
                        <div className={`content-section ${activeSection === 'empleados' ? 'active' : ''}`}>
                            <EmpleadosSection user={user} showNotification={showNotification} openaiApiKey={openaiApiKey} aiModel={aiModel} logActivity={logActivity} userRole={userRole} predefinedOptions={PREDEFINED_OPTIONS} profileToEdit={profileToEdit} setProfileToEdit={setProfileToEdit} jobProfiles={jobProfiles} setJobProfiles={setJobProfiles} />
                        </div>
                        <div className={`content-section ${activeSection === 'organigrama' ? 'active' : ''}`}>
                            <Organigrama jobProfiles={jobProfiles} onEditProfile={handleEditProfileFromChart} />
                        </div>
                    </div>
                    {userRole === 'employee' && <EmployeeFooter />}
                </>
            );
        };
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
