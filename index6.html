<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGEA Dev - Estudio Organizativo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #0079bf;
            --primary-hover: #026aa7;
            --primary-light: #a5d8ff;
            --secondary-color: #5e6c84;
            --danger-color: #de350b;
            --success-color: #4bbf6b;
            --warning-color: #f5cd47;
            --success-light-bg: #f0f9f4;
            --background-light: #f4f5f7;
            --background-white: #ffffff;
            --text-dark: #172b4d;
            --text-light: #5e6c84;
            --border-color: #dfe1e6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
        html, body { height: 100%; }
        body { display: flex; flex-direction: column; background-color: var(--background-light); min-height: 100vh; color: var(--text-dark); }
        #root { flex: 1 0 auto; }
        footer { flex-shrink: 0; text-align: center; padding: 20px; color: var(--text-light); font-size: 14px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--background-white); border-radius: 3px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 1px rgba(9,30,66,.25); }
        .header-title h1 { color: var(--text-dark); font-size: 24px; font-weight: 600; }
        .header-title p { color: var(--text-light); font-size: 14px; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .navigation { 
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; 
            padding-bottom: 10px; position: sticky; top: 0;
            background-color: var(--background-light); z-index: 10; padding-top: 10px; border-bottom: 1px solid var(--border-color);
        }
        .nav-btn { background: var(--background-white); border: none; padding: 10px 15px; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text-dark); transition: all 0.2s ease; box-shadow: 0 1px 0 rgba(9,30,66,.25); white-space: nowrap; }
        .nav-btn:hover { background-color: #ebecf0; }
        .nav-btn.active { background-color: #e4f0f6; color: var(--primary-color); box-shadow: inset 0 0 0 2px var(--primary-color); }
        .content-section { display: none; background: transparent; }
        .content-section.active { display: block; }
        .phase-header { background: var(--background-white); color: var(--text-dark); padding: 15px; border-radius: 3px; margin-bottom: 15px; box-shadow: 0 1px 1px rgba(9,30,66,.25); }
        .phase-header h2 { font-size: 18px; margin-bottom: 5px; font-weight: 600; }
        .phase-header p { font-size: 12px; color: var(--text-light); }
        .checklist { list-style: none; margin: 10px 0; }
        .checklist li { background: var(--background-white); margin: 5px 0; padding: 10px; border-radius: 3px; transition: all 0.3s ease; position: relative; box-shadow: 0 1px 0 rgba(9,30,66,.25); font-size: 14px; border-left: 3px solid transparent; }
        .checklist li.completed { background-color: var(--success-light-bg); border-left-color: var(--success-color); }
        .checklist li.completed .task-text { text-decoration: line-through; color: #9ca3af; }
        .task-checkbox { margin-right: 10px; cursor: pointer; flex-shrink: 0; }
        .task-checkbox:checked { accent-color: var(--success-color); }
        .task-text { flex-grow: 1; cursor: pointer; }
        .subsection { background: var(--background-white); padding: 20px; border-radius: 3px; margin: 15px 0; box-shadow: 0 1px 1px rgba(9,30,66,.25); }
        .subsection h3 { color: var(--text-dark); margin-bottom: 15px; font-size: 16px; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        .btn, .btn-action, .btn-secondary, .btn-logout, .btn-save, .btn-danger, .btn-success, .btn-warning { background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: 500; margin: 5px; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover, .btn-action:hover, .btn-secondary:hover, .btn-logout:hover, .btn-save:hover, .btn-danger:hover, .btn-success:hover, .btn-warning:hover { opacity: 0.9; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-warning { background-color: var(--warning-color); color: var(--text-dark); }
        .btn:disabled, .btn-action:disabled, .btn-danger:disabled, .btn-success:disabled { background-color: #a5adba; cursor: not-allowed; opacity: 0.7; }
        .notes-textarea, .form-input, .form-select, .form-textarea { width: 100%; margin-top: 5px; padding: 8px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px; }
        .notes-textarea { resize: none; overflow: hidden; }
        .form-textarea { min-height: 80px; resize: vertical; }
        .voice-btn { background: #f0f7fc; border: 1px solid #dfe1e6; border-radius: 50%; width: 32px; height: 32px; margin-left: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; flex-shrink: 0; }
        .voice-btn:hover { background: var(--primary-color); color: white; }
        .voice-btn.listening { background: #ff4d4d; color: white; animation: pulse 1.5s infinite; }
        .auth-container { max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: 5px; box-shadow: 0 4px 8px rgba(9,30,66,.25); text-align: center; }
        .auth-container h1 { justify-content: center; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 5px; color: white; z-index: 1002; animation: fadeInOut 4s ease-in-out; }
        .notification.success { background-color: #5aac44; }
        .notification.error { background-color: var(--danger-color); }
        .form-label { font-weight: 600; margin-top: 1rem; display: block; font-size: 14px; color: var(--text-dark); text-align: left; }
        .form-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .form-table th, .form-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 14px; vertical-align: middle; }
        .form-table th { background-color: #f8f9fa; font-weight: 600; }
        .form-table input, .form-table select { margin-top: 0; }
        .checkbox-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .checkbox-group label { font-weight: normal; font-size: 14px; display:flex; align-items:center; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001; }
        .modal-content { background: white; padding: 2rem; border-radius: 5px; max-width: 500px; text-align: left; }
        .modal-content-lg { max-width: 800px; text-align: left; }
        .signature-pad { border: 1px solid var(--border-color); border-radius: 3px; cursor: crosshair; }
        
        /* Styles for Org Chart */
        .org-chart-container { display: flex; justify-content: center; position: relative; overflow: auto; }
        .org-chart ul { padding-left: 20px; }
        .org-chart li { list-style-type: none; margin: 10px 0; position: relative; }
        .org-chart-node {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            display: inline-block;
            min-width: 180px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        .org-chart-node .name { font-size: 12px; color: var(--text-light); }
        .org-chart-node .role { font-weight: 600; color: var(--text-dark); }
        .edit-org-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #f0f0f0;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 10px;
            line-height: 20px;
            text-align: center;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; transform: translateY(-20px); } 10%, 90% { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>
    <footer style="color: var(--text-light); font-size: 14px;">
        <div class="flex justify-center mb-4">
            <img src="https://egea.creativiza.com/expansion/logo-783%20(1).png" alt="Logo de EGEA" class="h-10" />
        </div>
        <p style="display: flex; align-items: center; justify-content: center; gap: 5px;">
            Hecho con 
            <svg width="16" height="16" viewBox="0 0 24 24" fill="red" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.39 20.87a.696.696 0 0 1-.78 0C9.764 19.637 2 14.15 2 8.973c0-6.68 7.85-7.75 10-3.25 2.15-4.5 10-3.43 10 3.25 0 5.178-7.764 10.664-9.61 11.895z"/>
            </svg>
             por Hacchi
        </p>
    </footer>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useLayoutEffect } = React;
        const supabase = window.supabase; // Accede al objeto global supabase
        const { jsPDF } = window.jspdf;

        // --- SUPABASE CREDENTIALS ---
        const supabaseUrl = 'https://mtncylafoftawkuruinu.supabase.co';
        // Renamed for clarity and to potentially avoid obscure conflicts
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10bmN5bGFmb2Z0YXdrdXJ1aW51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5Nzc5MzAsImV4cCI6MjA2NzU1MzkzMH0.K3w1EiuhSXGbbEtY0muyDEUXvlxGkmnb9fCrv3eSuOU';
        const supabaseClient = supabase.createClient(supabaseUrl, SUPABASE_ANON_KEY); // Llama a createClient desde el objeto supabase

        // --- STUDY DATA ---
        const studyData = [ { id: 'dashboard', title: 'Visión General' }, { id: 'timeline', title: 'Cronograma', sections: [ { title: 'CRONOGRAMA GENERAL DEL ESTUDIO', description: 'Duración total: 8 semanas' }, { subtitle: 'Recursos Necesarios', tasks: ['1 Coordinador del estudio (dedicación 50%)', 'Participación de todos los empleados (entrevistas)', 'Apoyo de la dirección', 'Computadora con software de diagramación', 'Material de oficina para documentación', 'Acceso a información de la empresa', 'Costo de oportunidad del tiempo del personal', 'Posible consultoría externa (opcional)', 'Software especializado (opcional)'] }, { subtitle: 'Indicadores de Éxito del Estudio', tasks: ['Participación: 100% de empleados entrevistados', 'Documentación: Todos los procesos principales mapeados', 'Oportunidades: Al menos 10 mejoras identificadas', 'Consenso: Aceptación de dirección y empleados', 'Implementación: Plan de acción definido y aprobado'] } ] }, { id: 'phase1', title: 'Fase 1', sections: [ { title: 'FASE 1: PREPARACIÓN Y PLANIFICACIÓN', description: 'Tiempo estimado: 1-2 días' }, { subtitle: '1.1 Definición de Objetivos', tasks: ['Definir objetivo principal del estudio', 'Establecer 3-5 objetivos específicos y medibles', 'Documentar expectativas de la dirección', 'Identificar stakeholders clave'] }, { subtitle: '1.2 Conformación del Equipo de Estudio', tasks: ['Designar coordinador principal del estudio', 'Identificar personas clave para entrevistas', 'Definir cronograma detallado (4-6 semanas)', 'Comunicar el proyecto a toda la organización', 'Establecer metodología de trabajo'] } ] }, { id: 'phase2', title: 'Fase 2', sections: [ { title: 'FASE 2: DIAGNÓSTICO DE ESTRUCTURA ORGANIZATIVA', description: 'Tiempo estimado: 3-4 días' }, { subtitle: 'A) Identificación de Niveles Jerárquicos', tasks: ['Nivel Directivo: Gerencia general, socios, dirección', 'Nivel Intermedio: Jefes de área, supervisores', 'Nivel Operativo: Empleados de primera línea'] }, { subtitle: 'B) Departamentos y Áreas Funcionales', tasks: ['Área Comercial: Ventas, atención al cliente, desarrollo de negocio', 'Área de Diseño: Diseñadores, asesores de decoración', 'Área de Producción/Taller: Confección textil, carpintería, tapicería', 'Área de Compras: Proveedores, materiales, textiles', 'Área de Instalación: Equipos de montaje, logística de entrega', 'Área Administrativa: Contabilidad, RRHH, facturación', 'Área de Almacén: Gestión de stock, recepción, despacho'] }, { subtitle: '2.2 Análisis de Puestos de Trabajo', tasks: ['Denominación del puesto', 'Objetivo principal', 'Dependencia jerárquica (a quién reporta)', 'Personal a cargo (si aplica)', 'Responsabilidades principales (5-8 máximo)', 'Competencias requeridas', 'Interacciones internas (con qué áreas trabaja)', 'Interacciones externas (clientes, proveedores)'] } ] }, { id: 'phase3', title: 'Fase 3', sections: [ { title: 'FASE 3: ANÁLISIS DE PROCESOS INTERNOS', description: 'Tiempo estimado: 4-5 días' }, { subtitle: 'A) Procesos Estratégicos', tasks: ['Planificación estratégica', 'Desarrollo de nuevos productos/servicios', 'Gestión de la calidad'] }, { subtitle: 'B) Procesos Operativos (Core Business)', tasks: ['Proceso Comercial: Prospección → Presupuesto → Venta', 'Proceso de Diseño: Briefing → Propuesta → Aprobación', 'Proceso de Compras: Solicitud → Cotización → Compra', 'Proceso de Producción: Orden → Fabricación → Control de calidad', 'Proceso de Instalación: Programación → Instalación → Entrega', 'Proceso de Facturación: Venta → Factura → Cobro'] }, { subtitle: 'C) Procesos de Apoyo', tasks: ['Gestión de recursos humanos', 'Gestión financiera y contable', 'Mantenimiento y limpieza', 'Sistemas de información'] }, { subtitle: '3.2 Mapeo Detallado de Procesos', tasks: ['Objetivo del proceso', 'Responsable del proceso', 'Actividades paso a paso', 'Recursos necesarios', 'Tiempos de ejecución', 'Documentos/formularios utilizados', 'Indicadores de desempeño', 'Puntos críticos o cuellos de botella'] } ] }, { id: 'phase4', title: 'Fase 4', sections: [ { title: 'FASE 4: HERRAMIENTAS DE ANÁLISIS Y DOCUMENTACIÓN', description: 'Tiempo estimado: 2-3 días' }, { subtitle: 'A) Para Estructura Organizativa:', tasks: ['Organigrama funcional: Estructura jerárquica actual', 'Matriz de responsabilidades: RACI', 'Análisis de cargas de trabajo: Distribución por persona'] }, { subtitle: 'B) Para Procesos:', tasks: ['Diagramas de flujo: Representación visual de procesos', 'Mapas de procesos: Interrelación entre procesos', 'Matriz de procesos vs. estructura: Quién hace qué'] } ] }, { id: 'phase5', title: 'Fase 5', sections: [ { title: 'FASE 5: ANÁLISIS DE RESULTADOS', description: 'Tiempo estimado: 3-4 días' }, { subtitle: '5.1 Evaluación de la Estructura Actual', tasks: ['Eficiencia de la estructura: ¿Los niveles jerárquicos son apropiados?', 'Claridad de roles: ¿Todos conocen sus responsabilidades?', 'Comunicación: ¿Los canales son efectivos?', 'Sobrecarga/Subcarga: ¿Hay desequilibrio en cargas de trabajo?', 'Duplicidades: ¿Hay funciones repetidas innecesariamente?'] }, { subtitle: '5.2 Evaluación de Procesos', tasks: ['Eficiencia: ¿Los procesos son ágiles y efectivos?', 'Efectividad: ¿Se logran los objetivos esperados?', 'Calidad: ¿Los resultados cumplen los estándares?', 'Costos: ¿Los procesos son rentables?', 'Riesgos: ¿Existen puntos críticos de falla?'] } ] }, { id: 'phase6', title: 'Fase 6', sections: [ { title: 'FASE 6: IDENTIFICACIÓN DE OPORTUNIDADES DE MEJORA', description: 'Tiempo estimado: 3-4 días' }, { subtitle: '6.1 Problemas Identificados (Estructura Organizativa)', tasks: ['Problemas de comunicación', 'Falta de claridad en responsabilidades', 'Niveles jerárquicos inadecuados', 'Desequilibrio en cargas de trabajo'] }, { subtitle: '6.1 Problemas Identificados (Procesos)', tasks: ['Cuellos de botella', 'Actividades redundantes', 'Falta de estandarización', 'Ausencia de controles'] }, { subtitle: '6.2 Oportunidades de Mejora (Priorización)', tasks: ['Impacto en el negocio (Alto/Medio/Bajo)', 'Facilidad de implementación (Fácil/Media/Difícil)', 'Recursos requeridos (Altos/Medios/Bajos)', 'Tiempo de implementación (Corto/Medio/Largo plazo)'] } ] }, { id: 'phase7', title: 'Fase 7', sections: [ { title: 'FASE 7: PLAN DE IMPLEMENTACIÓN', description: 'Tiempo estimado: 4-5 días' }, { subtitle: '7.1 Propuestas de Mejora', tasks: ['Descripción de la mejora', 'Objetivos específicos', 'Responsable de implementación', 'Cronograma', 'Recursos necesarios', 'Indicadores de éxito', 'Riesgos y contingencias'] }, { subtitle: '7.2 Cronograma de Implementación', tasks: ['Fase 1: Mejoras de corto plazo (1-3 meses)', 'Fase 2: Mejoras de mediano plazo (3-6 meses)', 'Fase 3: Mejoras de largo plazo (6-12 meses)'] } ] }, { id: 'summaries', title: 'Resumenes' } ];
        const allTaskIds = studyData.flatMap(phase => phase.sections?.flatMap(section => section.tasks || []) || []).filter(Boolean);

        // --- ICONS ---
        const MicIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>;
        const LoaderIcon = () => <div className="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>;
        const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const SettingsIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>;
        const SparklesIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.553L16.5 21.75l-.398-1.197a3.375 3.375 0 00-2.455-2.455L12.75 18l1.197-.398a3.375 3.375 0 002.455 2.455l.398-1.197.398 1.197a3.375 3.375 0 002.455 2.455l1.197.398-1.197.398a3.375 3.375 0 00-2.455 2.455z"/></svg>;
        const CopyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const MenuIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>;
        const XIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;


        // --- HOOKS ---
        const useAutosizeTextArea = (textAreaRef, value) => {
            useEffect(() => {
                if (textAreaRef && textAreaRef.current) {
                    textAreaRef.current.style.height = "0px";
                    const scrollHeight = textAreaRef.current.scrollHeight;
                    textAreaRef.current.style.height = scrollHeight + "px";
                }
            }, [textAreaRef, value]);
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setLoading(false);
                });
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                });
                return () => subscription.unsubscribe();
            }, []);

            if (loading) {
                return <div className="flex justify-center items-center h-screen"><LoaderIcon /></div>;
            }
            
            return session ? <EstudioApp user={session.user} /> : <Auth />;
        };
        
        // --- AUTH COMPONENT ---
        const Auth = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [view, setView] = useState('express'); // 'express', 'login', 'signUp'
            const [message, setMessage] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');
                try {
                    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                } catch (error) {
                    setMessage(error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSignUp = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');
                try {
                    const { data, error } = await supabaseClient.auth.signUp({ email, password });
                    if (error) throw error;
                    if (data.user) {
                        const { error: profileError } = await supabaseClient
                            .from('profiles')
                            .insert({ id: data.user.id, role: 'employee' }); // Asignar rol por defecto
                        if (profileError) throw profileError;
                    }
                    setMessage('¡Registro exitoso! Revisa tu correo para verificar la cuenta.');
                } catch (error) {
                    setMessage(`Error: ${error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const handleExpressLink = async (e) => {
                e.preventDefault();
                if (!email) {
                    setMessage("Por favor, introduce tu email para recibir el enlace de acceso.");
                    return;
                }
                setLoading(true);
                setMessage('');
                try {
                    const { error } = await supabaseClient.auth.signInWithOtp({ email });
                    if (error) throw error;
                    setMessage('¡Revisa tu correo! Te hemos enviado un enlace para iniciar sesión.');
                } catch (error) {
                    setMessage(error.message);
                } finally {
                    setLoading(false);
                }
            };
            
            return ( 
                <div className="auth-container"> 
                    <div className="flex justify-center mb-4"><img src="https://egea.creativiza.com/expansion/logo-783%20(1).png" alt="Logo de EGEA" className="h-12" /></div>
                    
                    {view === 'express' && (
                         <>
                            <h2 className="text-xl font-bold text-center mb-6">Acceso Express</h2> 
                            <form onSubmit={handleExpressLink} className="space-y-4"> 
                                <input type="email" placeholder="tu-correo@egea.com" value={email} onChange={e => setEmail(e.target.value)} required className="w-full p-2 border rounded-md text-center" /> 
                                <button type="submit" className="w-full btn-success justify-center" disabled={loading}>
                                    {loading ? <LoaderIcon /> : 'Enviar Enlace de Acceso'}
                                </button> 
                            </form>
                            <div className="mt-4 text-center">
                                <a href="#" onClick={(e) => { e.preventDefault(); setView('login'); }} className="text-sm text-blue-600 hover:underline">
                                    O iniciar sesión con contraseña
                                </a>
                            </div>
                        </>
                    )}

                    {view === 'login' && (
                        <>
                            <h2 className="text-xl font-bold text-center mb-6">Iniciar Sesión</h2> 
                            <form onSubmit={handleLogin} className="space-y-4"> 
                                <input type="email" placeholder="correo@ejemplo.com" value={email} onChange={e => setEmail(e.target.value)} required className="w-full p-2 border rounded-md text-center" /> 
                                <input type="password" placeholder="Contraseña" value={password} onChange={e => setPassword(e.target.value)} required className="w-full p-2 border rounded-md text-center" /> 
                                <button type="submit" className="w-full btn-action justify-center" disabled={loading}>
                                    {loading ? <LoaderIcon /> : 'Entrar'}
                                </button> 
                            </form>
                            <p className="text-center mt-4">
                                <a href="#" onClick={(e) => { e.preventDefault(); setView('signUp'); }} className="text-sm text-blue-600 hover:underline">
                                   ¿No tienes cuenta? Regístrate
                                </a>
                            </p>
                             <div className="mt-2 text-center">
                                <a href="#" onClick={(e) => { e.preventDefault(); setView('express'); }} className="text-xs text-gray-500 hover:underline">
                                    Volver a Acceso Express
                                </a>
                            </div>
                        </>
                    )}

                    {view === 'signUp' && (
                         <>
                            <h2 className="text-xl font-bold text-center mb-6">Registrarse</h2> 
                            <form onSubmit={handleSignUp} className="space-y-4"> 
                                <input type="email" placeholder="correo@ejemplo.com" value={email} onChange={e => setEmail(e.target.value)} required className="w-full p-2 border rounded-md text-center" /> 
                                <input type="password" placeholder="Crea una contraseña" value={password} onChange={e => setPassword(e.target.value)} required className="w-full p-2 border rounded-md text-center" /> 
                                <button type="submit" className="w-full btn-action justify-center" disabled={loading}>
                                    {loading ? <LoaderIcon /> : 'Crear Cuenta'}
                                </button> 
                            </form>
                             <p className="text-center mt-4">
                                <a href="#" onClick={(e) => { e.preventDefault(); setView('login'); }} className="text-sm text-blue-600 hover:underline">
                                    ¿Ya tienes cuenta? Inicia sesión
                                </a>
                            </p>
                        </>
                    )}
                    
                    {message && <p className={`mt-4 text-center text-sm ${message.startsWith('Error') ? 'text-red-600' : 'text-green-600'}`}>{message}</p>} 
                </div> 
            );
        };
        
        // --- TASK ITEM COMPONENT ---
        const TaskItem = ({ taskId, taskState, onToggle, onNoteChange, onRecord, onSummarize, isEditing, onEditClick }) => {
            const { isRecording, isProcessing, activeTaskId } = onRecord;
            const { is_completed, notes } = taskState;
            const summarySeparator = '--- Resumen IA ---';
            const hasSummary = notes && notes.includes(summarySeparator);
            const mainNotes = hasSummary ? notes.split(summarySeparator)[0].trim() : notes;
            const summaryText = hasSummary ? notes.split(summarySeparator)[1].trim() : null;
            const textAreaRef = useRef(null);
            const summaryTextAreaRef = useRef(null);

            useAutosizeTextArea(textAreaRef, mainNotes);
            useAutosizeTextArea(summaryTextAreaRef, summaryText);

            const handleBlur = (e) => {
                const newNotes = e.target.value;
                const finalNotes = summaryText ? `${newNotes}\n\n${summarySeparator}\n${summaryText}` : newNotes;
                onNoteChange(taskId, { notes: finalNotes });
            };

            const handleDeleteSummary = () => {
                onNoteChange(taskId, { notes: mainNotes });
            };

            return (
                 <li className={is_completed ? 'completed' : ''}>
                    <div className="flex items-start">
                        <input type="checkbox" className="task-checkbox mt-1" checked={is_completed} onChange={() => onToggle(taskId, { is_completed: !is_completed })} />
                        <div className="flex-grow">
                            <span className="task-text" onClick={() => onEditClick(taskId)}>{taskId}</span>
                            {isEditing && (
                                <div className="mt-2">
                                    <textarea 
                                        ref={textAreaRef}
                                        className="notes-textarea" 
                                        placeholder="Escribe tus notas aquí o usa el micrófono..." 
                                        defaultValue={mainNotes} 
                                        onBlur={handleBlur} 
                                        autoFocus 
                                    />
                                    <div className="flex items-center mt-1">
                                         <button type="button" onClick={() => onRecord.handle(taskId)} className={`voice-btn ${isRecording && activeTaskId === taskId ? 'listening' : ''}`} disabled={isProcessing}>
                                            {(isRecording && activeTaskId === taskId) ? <LoaderIcon /> : <MicIcon />}
                                        </button>
                                         <button type="button" onClick={() => onSummarize(taskId)} className="btn-secondary text-xs px-2 py-1 ml-2" disabled={isProcessing || !mainNotes || isRecording}>
                                            {(isProcessing && activeTaskId === taskId) ? <LoaderIcon /> : 'Resumen con IA'}
                                        </button>
                                        {hasSummary && (
                                            <button type="button" onClick={handleDeleteSummary} className="btn-danger text-xs px-2 py-1 ml-2">Borrar Resumen</button>
                                        )}
                                    </div>
                                    {summaryText && (
                                        <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                            <h4 className="font-semibold text-sm text-blue-800">Resumen de IA</h4>
                                            <textarea
                                                ref={summaryTextAreaRef}
                                                readOnly
                                                className="w-full bg-transparent border-none focus:ring-0 p-0 m-0 text-sm text-gray-700 mt-1 resize-none"
                                                value={summaryText}
                                            />
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </li>
            );
        }

        // --- JOB PROFILE FORM COMPONENT ---
        const JobProfileForm = ({ user, onSave, onCancel, showNotification, profileToEdit, predefinedOptions, logActivity }) => {
            const [formData, setFormData] = useState({
                nombre_apellidos: '', nombre_puesto: '', departamento: '', ubicacion: '', reporta_a: '', proposito: '',
                competencias_tecnicas: '', competencias_transversales: '', formacion: '', experiencia: '', horario: '',
                tipo_contrato: '', modalidad_trabajo: '', riesgos: '', herramientas: '', observaciones: '', firmado_por: '', fecha_firma: '', signature_data_url: ''
            });
            const [subordinados, setSubordinados] = useState(['']);
            const [funciones, setFunciones] = useState([{ funcion: '', frecuencia: [], responsabilidad: [] }]);
            const [kpis, setKpis] = useState(['']);
            const [relaciones, setRelaciones] = useState([{ tipo: 'Interna', con_quien: '', motivo: '' }]);
            const [isSaving, setIsSaving] = useState(false);
            const signaturePadRef = useRef(null);
            const canvasRef = useRef(null);

            const resizeCanvas = useCallback(() => {
                if (canvasRef.current) {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    const canvas = canvasRef.current;
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    if (signaturePadRef.current) {
                        signaturePadRef.current.fromData(signaturePadRef.current.toData());
                    }
                }
            }, []);

            useEffect(() => {
                if (canvasRef.current) {
                    signaturePadRef.current = new SignaturePad(canvasRef.current);
                    resizeCanvas();
                    window.addEventListener("resize", resizeCanvas);
                    if (profileToEdit && profileToEdit.signature_data_url) {
                        signaturePadRef.current.fromDataURL(profileToEdit.signature_data_url);
                    }
                }
                return () => {
                    window.removeEventListener("resize", resizeCanvas);
                };
            }, [profileToEdit, resizeCanvas]);

            useEffect(() => {
                if (profileToEdit) {
                    setFormData({
                        nombre_apellidos: profileToEdit.nombre_apellidos || '',
                        nombre_puesto: profileToEdit.nombre_puesto || '',
                        departamento: profileToEdit.departamento || '',
                        ubicacion: profileToEdit.ubicacion || '',
                        reporta_a: profileToEdit.reporta_a || '',
                        proposito: profileToEdit.proposito || '',
                        competencias_tecnicas: profileToEdit.competencias_tecnicas || '',
                        competencias_transversales: profileToEdit.competencias_transversales || '',
                        formacion: profileToEdit.formacion || '',
                        experiencia: profileToEdit.experiencia || '',
                        horario: profileToEdit.horario || '',
                        tipo_contrato: profileToEdit.tipo_contrato || '',
                        modalidad_trabajo: profileToEdit.modalidad_trabajo || '',
                        riesgos: profileToEdit.riesgos || '',
                        herramientas: profileToEdit.herramientas || '',
                        observaciones: profileToEdit.observaciones || '',
                        firmado_por: profileToEdit.firmado_por || '',
                        fecha_firma: profileToEdit.fecha_firma || '',
                        signature_data_url: profileToEdit.signature_data_url || '',
                        approved: profileToEdit.approved || false,
                    });
                    setSubordinados(profileToEdit.subordinados && profileToEdit.subordinados.length > 0 ? profileToEdit.subordinados : ['']);
                    setFunciones(profileToEdit.funciones && profileToEdit.funciones.length > 0 ? profileToEdit.funciones : [{ funcion: '', frecuencia: [], responsabilidad: [] }]);
                    setKpis(profileToEdit.kpis && profileToEdit.kpis.length > 0 ? profileToEdit.kpis : ['']);
                    setRelaciones(profileToEdit.relaciones && profileToEdit.relaciones.length > 0 ? profileToEdit.relaciones : [{ tipo: 'Interna', con_quien: '', motivo: '' }]);
                }
            }, [profileToEdit]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            
            const handleDynamicChange = (setter, index, field, value) => {
                setter(prev => {
                    const items = [...prev];
                    if (field) {
                        items[index][field] = value;
                    } else {
                        items[index] = value;
                    }
                    return items;
                });
            };
            
            const handleCheckboxChange = (setter, index, field, value) => {
                setter(prev => {
                    const items = [...prev];
                    const currentValues = items[index][field] || [];
                    if (currentValues.includes(value)) {
                        items[index][field] = currentValues.filter(v => v !== value);
                    } else {
                        items[index][field] = [...currentValues, value];
                    }
                    return items;
                });
            };

            const addDynamicItem = (setter, newItem) => setter(prev => [...prev, newItem]);
            const removeDynamicItem = (setter, index) => setter(prev => prev.filter((_, i) => i !== index));

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                
                let signatureURL = formData.signature_data_url;
                if (signaturePadRef.current && !signaturePadRef.current.isEmpty()) {
                    signatureURL = signaturePadRef.current.toDataURL();
                }

                const completeData = {
                    ...formData,
                    user_id: user.id,
                    signature_data_url: signatureURL,
                    subordinados: subordinados.filter(s => s && s.trim() !== ''),
                    funciones: funciones.filter(f => f.funcion && f.funcion.trim() !== ''),
                    kpis: kpis.filter(k => k && k.trim() !== ''),
                    relaciones: relaciones.filter(r => r.con_quien && r.con_quien.trim() !== '')
                };
                
                try {
                    let error;
                    if (profileToEdit) {
                        const { error: updateError } = await supabaseClient.from('job_profiles').update(completeData).eq('id', profileToEdit.id);
                        error = updateError;
                        if (!error) logActivity(`Editada ficha de ${completeData.nombre_apellidos}`);
                    } else {
                        const newId = Math.random().toString(36).substring(2, 8).toUpperCase();
                        const { error: insertError } = await supabaseClient.from('job_profiles').insert([{ ...completeData, id: newId }]);
                        error = insertError;
                        if (!error) logActivity(`Creada ficha de ${completeData.nombre_apellidos}`);
                    }

                    if (error) throw error;
                    showNotification(`Ficha de puesto ${profileToEdit ? 'actualizada' : 'guardada'} con éxito.`, 'success');
                    onSave();
                } catch (error) {
                    showNotification(`Error al ${profileToEdit ? 'actualizar' : 'guardar'} la ficha: ${error.message}`, 'error');
                } finally {
                    setIsSaving(false);
                }
            };
            
            return (
                <div className="subsection">
                    <form onSubmit={handleSubmit}>
                        <h2 className="text-xl font-bold mb-4 border-b pb-2">{profileToEdit ? 'Editar' : 'Nueva'} Ficha de Puesto de Trabajo</h2>
                        
                        <h3 className="text-lg font-semibold mt-4">1. Identificación del Puesto</h3>
                        <label className="form-label" htmlFor="nombre_apellidos">Nombre y Apellidos</label>
                        <input className="form-input" type="text" id="nombre_apellidos" name="nombre_apellidos" value={formData.nombre_apellidos} onChange={handleInputChange} required />
                        
                        <label className="form-label" htmlFor="nombre_puesto">Puesto</label>
                        <select className="form-select" id="nombre_puesto" name="nombre_puesto" value={formData.nombre_puesto} onChange={handleInputChange} required>
                            <option value="">Selecciona un puesto...</option>
                            {predefinedOptions.puestos.map(puesto => <option key={puesto} value={puesto}>{puesto}</option>)}
                        </select>
                        
                        <label className="form-label" htmlFor="departamento">Departamento / Área</label>
                        <select className="form-select" id="departamento" name="departamento" value={formData.departamento} onChange={handleInputChange} required>
                            <option value="">Selecciona un departamento...</option>
                            {predefinedOptions.departamentos.map(dep => <option key={dep} value={dep}>{dep}</option>)}
                        </select>

                        <label className="form-label" htmlFor="ubicacion">Ubicación</label>
                        <input className="form-input" type="text" id="ubicacion" name="ubicacion" value={formData.ubicacion} onChange={handleInputChange} />

                        <label className="form-label" htmlFor="reporta_a">Reporta a</label>
                         <select className="form-select" id="reporta_a" name="reporta_a" value={formData.reporta_a} onChange={handleInputChange}>
                            <option value="">Selecciona a quién reporta...</option>
                            {predefinedOptions.reporta_a.map(rep => <option key={rep} value={rep}>{rep}</option>)}
                        </select>

                        <label className="form-label">Subordinados directos</label>
                        {subordinados.map((sub, index) => (
                            <div key={index} className="flex gap-2 mb-2">
                                <input className="form-input" type="text" value={sub} onChange={e => handleDynamicChange(setSubordinados, index, null, e.target.value)} placeholder="Puesto del subordinado"/>
                                {index > 0 && <button type="button" onClick={() => removeDynamicItem(setSubordinados, index)} className="btn-danger p-2 leading-none">X</button>}
                            </div>
                        ))}
                        <button type="button" onClick={() => addDynamicItem(setSubordinados, '')} className="btn-secondary text-sm mt-1">+ Añadir subordinado</button>
                        
                        <h3 className="text-lg font-semibold mt-6">2. Propósito y Funciones</h3>
                        <label className="form-label" htmlFor="proposito">Propósito General del Puesto</label>
                        <textarea className="form-textarea" id="proposito" name="proposito" value={formData.proposito} onChange={handleInputChange} required></textarea>

                        <label className="form-label mt-6">Funciones y Tareas Principales</label>
                        <table className="form-table">
                            <thead><tr><th style={{width: '5%'}}>#</th><th>Función / Tarea</th><th>Frecuencia</th><th>Responsabilidad</th><th style={{width: '5%'}}></th></tr></thead>
                            <tbody>
                            {funciones.map((item, index) => (
                                <tr key={index}>
                                    <td>{index + 1}</td>
                                    <td><input type="text" placeholder="Función / Tarea" className="form-input" value={item.funcion} onChange={e => handleDynamicChange(setFunciones, index, 'funcion', e.target.value)} /></td>
                                    <td>
                                        <div className="checkbox-group">
                                            {['Diaria', 'Semanal', 'Mensual'].map(freq => <label key={freq}><input type="checkbox" className="mr-1" checked={(item.frecuencia || []).includes(freq)} onChange={() => handleCheckboxChange(setFunciones, index, 'frecuencia', freq)}/>{freq}</label>)}
                                        </div>
                                    </td>
                                    <td>
                                        <div className="checkbox-group">
                                            {['Alta', 'Media', 'Baja'].map(resp => <label key={resp}><input type="checkbox" className="mr-1" checked={(item.responsabilidad || []).includes(resp)} onChange={() => handleCheckboxChange(setFunciones, index, 'responsabilidad', resp)}/>{resp}</label>)}
                                        </div>
                                    </td>
                                    <td>{index > 0 && <button type="button" onClick={() => removeDynamicItem(setFunciones, index)} className="btn-danger p-2 leading-none">X</button>}</td>
                                </tr>
                            ))}
                            </tbody>
                        </table>
                        <button type="button" onClick={() => addDynamicItem(setFunciones, { funcion: '', frecuencia: [], responsabilidad: [] })} className="btn-secondary text-sm mt-2">+ Añadir función</button>
                        
                        <h3 className="text-lg font-semibold mt-6">3. KPIs y Observaciones</h3>
                        <label className="form-label">KPIs / Indicadores de Desempeño</label>
                        {kpis.map((kpi, index) => (
                            <div key={index} className="flex gap-2 mb-2">
                                <input className="form-input" type="text" value={kpi} onChange={e => handleDynamicChange(setKpis, index, null, e.target.value)} placeholder="Ej: Nivel de satisfacción del cliente > 90%"/>
                                {index > 0 && <button type="button" onClick={() => removeDynamicItem(setKpis, index)} className="btn-danger p-2 leading-none">X</button>}
                            </div>
                        ))}
                        <button type="button" onClick={() => addDynamicItem(setKpis, '')} className="btn-secondary text-sm mt-1">+ Añadir KPI</button>

                        <label className="form-label mt-6" htmlFor="observaciones">Observaciones</label>
                        <textarea className="form-textarea" name="observaciones" id="observaciones" value={formData.observaciones} onChange={handleInputChange}></textarea>


                        <h3 className="text-lg font-semibold mt-6">4. Competencias Requeridas</h3>
                        <label className="form-label" htmlFor="competencias_tecnicas">Competencias técnicas / específicas</label>
                        <textarea className="form-textarea" id="competencias_tecnicas" name="competencias_tecnicas" value={formData.competencias_tecnicas} onChange={handleInputChange}></textarea>
                        <label className="form-label" htmlFor="competencias_transversales">Competencias transversales / blandas</label>
                        <textarea className="form-textarea" id="competencias_transversales" name="competencias_transversales" value={formData.competencias_transversales} onChange={handleInputChange}></textarea>
                        <label className="form-label" htmlFor="formacion">Formación mínima requerida</label>
                        <input className="form-input" type="text" id="formacion" name="formacion" value={formData.formacion} onChange={handleInputChange} />
                        <label className="form-label" htmlFor="experiencia">Experiencia mínima requerida</label>
                        <input className="form-input" type="text" id="experiencia" name="experiencia" value={formData.experiencia} onChange={handleInputChange} />

                        <h3 className="text-lg font-semibold mt-6">5. Condiciones del Puesto</h3>
                        <label className="form-label" htmlFor="horario">Horario</label>
                        <input className="form-input" type="text" id="horario" name="horario" value={formData.horario} onChange={handleInputChange} placeholder="Ej: 09:00 - 18:00"/>
                        <label className="form-label" htmlFor="tipo_contrato">Tipo de contrato</label>
                        <select className="form-select" id="tipo_contrato" name="tipo_contrato" value={formData.tipo_contrato} onChange={handleInputChange}>
                            <option value="">Selecciona un tipo de contrato...</option>
                            {predefinedOptions.tipos_contrato.map(con => <option key={con} value={con}>{con}</option>)}
                        </select>
                        <label className="form-label" htmlFor="modalidad_trabajo">Modalidad de trabajo</label>
                        <input className="form-input" type="text" id="modalidad_trabajo" name="modalidad_trabajo" value={formData.modalidad_trabajo} onChange={handleInputChange} />
                        <label className="form-label" htmlFor="riesgos">Riesgos asociados</label>
                        <textarea className="form-textarea" id="riesgos" name="riesgos" value={formData.riesgos} onChange={handleInputChange}></textarea>
                        <label className="form-label" htmlFor="herramientas">Equipos o herramientas clave</label>
                        <textarea className="form-textarea" id="herramientas" name="herramientas" value={formData.herramientas} onChange={handleInputChange}></textarea>

                        <h3 className="text-lg font-semibold mt-6">6. Relaciones Internas y Externas</h3>
                        <table className="form-table">
                            <thead><tr><th>Tipo</th><th>Con quién</th><th>Motivo / Resultado esperado</th><th style={{width: '5%'}}></th></tr></thead>
                            <tbody>
                            {relaciones.map((item, index) => (
                                <tr key={index}>
                                    <td>
                                        <select className="form-select" value={item.tipo} onChange={e => handleDynamicChange(setRelaciones, index, 'tipo', e.target.value)}>
                                            <option>Interna</option>
                                            <option>Externa</option>
                                        </select>
                                    </td>
                                    <td><input type="text" placeholder="Con quién" className="form-input" value={item.con_quien} onChange={e => handleDynamicChange(setRelaciones, index, 'con_quien', e.target.value)} /></td>
                                    <td><input type="text" placeholder="Motivo" className="form-input" value={item.motivo} onChange={e => handleDynamicChange(setRelaciones, index, 'motivo', e.target.value)} /></td>
                                    <td>{index > 0 && <button type="button" onClick={() => removeDynamicItem(setRelaciones, index)} className="btn-danger p-2 leading-none">X</button>}</td>
                                </tr>
                            ))}
                            </tbody>
                        </table>
                        <button type="button" onClick={() => addDynamicItem(setRelaciones, { tipo: 'Interna', con_quien: '', motivo: '' })} className="btn-secondary text-sm mt-2">+ Añadir relación</button>

                        <h3 className="text-lg font-semibold mt-6">7. Firma</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="form-label" htmlFor="firmado_por">Firmado por</label>
                                <input className="form-input" type="text" id="firmado_por" name="firmado_por" value={formData.firmado_por} onChange={handleInputChange} required />
                            </div>
                            <div>
                                <label className="form-label" htmlFor="fecha_firma">Fecha</label>
                                <input className="form-input" type="date" id="fecha_firma" name="fecha_firma" value={formData.fecha_firma} onChange={handleInputChange} required />
                            </div>
                        </div>
                        <div className="mt-4">
                            <label className="form-label">Panel de Firma</label>
                            <canvas ref={canvasRef} className="signature-pad w-full h-40"></canvas>
                            <button type="button" onClick={() => signaturePadRef.current && signaturePadRef.current.clear()} className="btn-secondary text-sm mt-2">Limpiar Firma</button>
                        </div>

                        <div className="mt-6 flex justify-end gap-4">
                            <button type="button" onClick={onCancel} className="btn-secondary">Cancelar</button>
                            <button type="submit" className="btn-action" disabled={isSaving}>
                                {isSaving && <LoaderIcon />}
                                {isSaving ? 'Guardando...' : 'Guardar Cambios'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };
        
        // --- MODAL & DETAIL COMPONENTS ---
        const ConfirmationModal = ({ message, onConfirm, onCancel }) => {
            return (
                <div className="modal-overlay">
                    <div className="modal-content text-center">
                        <p className="mb-4">{message}</p>
                        <div className="flex justify-center gap-4">
                            <button onClick={onCancel} className="btn-secondary">Cancelar</button>
                            <button onClick={onConfirm} className="btn-danger">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const JobProfileDetail = ({ profile, onBack, onEdit, onDelete, onExportPDF, onGenerateDescription, userRole }) => {
            const detailRef = useRef(null);

            const renderList = (items) => {
                if (!items || items.length === 0) return <p className="text-gray-500 italic">No especificado</p>;
                return <ul className="list-disc list-inside text-gray-800">{items.map((item, index) => <li key={index}>{item}</li>)}</ul>;
            };

            return (
                <div className="subsection p-0">
                    {/* The ref is on the container that will be captured by html2canvas */}
                    <div ref={detailRef} className="p-6 bg-white">
                        <h2 className="text-2xl font-bold mb-6 border-b pb-3 text-center text-gray-800">Ficha de Puesto de Trabajo</h2>
                        
                        {/* Section 1 */}
                        <h3 className="text-xl font-semibold mt-4 mb-3 text-gray-700">1. Identificación del Puesto</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                            <div><p className="font-semibold text-gray-600 text-sm">ID:</p><p className="text-gray-800">{profile.id || 'N/A'}</p></div>
                            <div><p className="font-semibold text-gray-600 text-sm">Nombre y Apellidos:</p><p className="text-gray-800">{profile.nombre_apellidos || 'N/A'}</p></div>
                            <div><p className="font-semibold text-gray-600 text-sm">Puesto:</p><p className="text-gray-800">{profile.nombre_puesto || 'N/A'}</p></div>
                            <div><p className="font-semibold text-gray-600 text-sm">Departamento / Área:</p><p className="text-gray-800">{profile.departamento || 'N/A'}</p></div>
                            <div><p className="font-semibold text-gray-600 text-sm">Ubicación:</p><p className="text-gray-800">{profile.ubicacion || 'N/A'}</p></div>
                            <div><p className="font-semibold text-gray-600 text-sm">Reporta a:</p><p className="text-gray-800">{profile.reporta_a || 'N/A'}</p></div>
                        </div>
                        <div className="mt-4"><p className="font-semibold text-gray-600 text-sm mb-1">Subordinados directos:</p>{renderList(profile.subordinados)}</div>

                        {/* Section 2 */}
                        <div className="mt-6 pt-4 border-t"><h3 className="text-xl font-semibold mb-2 text-gray-700">2. Propósito y Funciones</h3>
                            <p className="font-semibold text-gray-600 text-sm">Propósito General del Puesto:</p>
                            <p className="text-gray-800 whitespace-pre-wrap mt-1">{profile.proposito || 'No especificado'}</p>
                        </div>
                        <div className="mt-4">
                            <p className="font-semibold text-gray-600 text-sm mb-2">Funciones y Tareas Principales:</p>
                            {(!profile.funciones || profile.funciones.length === 0) ? <p className="text-gray-500 italic">No especificadas</p> : (
                                <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-gray-500">
                                    <thead className="text-xs text-gray-700 uppercase bg-gray-50"><tr><th className="px-4 py-2">Función / Tarea</th><th className="px-4 py-2">Frecuencia</th><th className="px-4 py-2">Responsabilidad</th></tr></thead>
                                    <tbody>{profile.funciones.map((f, i) => (<tr key={i} className="bg-white border-b"><td className="px-4 py-2 font-medium text-gray-900">{f.funcion}</td><td className="px-4 py-2">{f.frecuencia?.join(', ') || 'N/A'}</td><td className="px-4 py-2">{f.responsabilidad?.join(', ') || 'N/A'}</td></tr>))}</tbody>
                                </table>
                                </div>
                            )}
                        </div>

                        {/* Section 3 */}
                        <div className="mt-6 pt-4 border-t"><h3 className="text-xl font-semibold mb-2 text-gray-700">3. KPIs y Observaciones</h3>
                            <p className="font-semibold text-gray-600 text-sm mb-1">KPIs / Indicadores de Desempeño:</p>
                            {renderList(profile.kpis)}
                            <p className="font-semibold text-gray-600 text-sm mt-4">Observaciones:</p>
                            <p className="text-gray-800 whitespace-pre-wrap mt-1">{profile.observaciones || 'No especificadas'}</p>
                        </div>

                        {/* Section 4 */}
                        <div className="mt-6 pt-4 border-t"><h3 className="text-xl font-semibold mb-3 text-gray-700">4. Competencias Requeridas</h3>
                             <p className="font-semibold text-gray-600 text-sm">Competencias técnicas / específicas:</p>
                            <p className="text-gray-800 whitespace-pre-wrap mt-1">{profile.competencias_tecnicas || 'No especificadas'}</p>
                             <p className="font-semibold text-gray-600 text-sm mt-4">Competencias transversales / blandas:</p>
                            <p className="text-gray-800 whitespace-pre-wrap mt-1">{profile.competencias_transversales || 'No especificadas'}</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mt-4">
                                <div><p className="font-semibold text-gray-600 text-sm">Formación mínima requerida:</p><p className="text-gray-800">{profile.formacion || 'N/A'}</p></div>
                                <div><p className="font-semibold text-gray-600 text-sm">Experiencia mínima requerida:</p><p className="text-gray-800">{profile.experiencia || 'N/A'}</p></div>
                            </div>
                        </div>

                         {/* Section 5 */}
                        <div className="mt-6 pt-4 border-t"><h3 className="text-xl font-semibold mb-3 text-gray-700">5. Condiciones del Puesto</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <div><p className="font-semibold text-gray-600 text-sm">Horario:</p><p className="text-gray-800">{profile.horario || 'N/A'}</p></div>
                                <div><p className="font-semibold text-gray-600 text-sm">Tipo de contrato:</p><p className="text-gray-800">{profile.tipo_contrato || 'N/A'}</p></div>
                                <div><p className="font-semibold text-gray-600 text-sm">Modalidad de trabajo:</p><p className="text-gray-800">{profile.modalidad_trabajo || 'N/A'}</p></div>
                            </div>
                            <p className="font-semibold text-gray-600 text-sm mt-4">Riesgos asociados:</p>
                            <p className="text-gray-800 whitespace-pre-wrap mt-1">{profile.riesgos || 'No especificados'}</p>
                            <p className="font-semibold text-gray-600 text-sm mt-4">Equipos o herramientas clave:</p>
                            <p className="text-gray-800 whitespace-pre-wrap mt-1">{profile.herramientas || 'No especificadas'}</p>
                        </div>

                        {/* Section 6 */}
                        <div className="mt-6 pt-4 border-t"><h3 className="text-xl font-semibold mb-2 text-gray-700">6. Relaciones Internas y Externas</h3>
                            {(!profile.relaciones || profile.relaciones.length === 0) ? <p className="text-gray-500 italic">No especificadas</p> : (
                                <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-gray-500">
                                   <thead className="text-xs text-gray-700 uppercase bg-gray-50"><tr><th className="px-4 py-2">Tipo</th><th className="px-4 py-2">Con quién</th><th className="px-4 py-2">Motivo</th></tr></thead>
                                    <tbody>{profile.relaciones.map((r, i) => (<tr key={i} className="bg-white border-b"><td className="px-4 py-2">{r.tipo}</td><td className="px-4 py-2">{r.con_quien}</td><td className="px-4 py-2">{r.motivo}</td></tr>))}</tbody>
                                </table>
                                </div>
                            )}
                        </div>

                        {/* Section 7 */}
                        <div className="mt-6 pt-4 border-t"><h3 className="text-xl font-semibold mb-3 text-gray-700">7. Firma</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <div><p className="font-semibold text-gray-600 text-sm">Firmado por:</p><p className="text-gray-800">{profile.firmado_por || 'N/A'}</p></div>
                                <div><p className="font-semibold text-gray-600 text-sm">Fecha:</p><p className="text-gray-800">{profile.fecha_firma ? new Date(profile.fecha_firma).toLocaleDateString() : 'N/A'}</p></div>
                            </div>
                             {profile.signature_data_url && (
                                <div className="mt-4">
                                    <p className="font-semibold text-gray-600 text-sm">Firma:</p>
                                    <img src={profile.signature_data_url} alt="Firma" className="mt-2 border rounded max-w-xs bg-gray-50" />
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Action buttons outside the printable area */}
                    <div className="flex flex-wrap justify-end gap-2 mt-4 border-t pt-4 px-6 pb-4">
                        <button onClick={onBack} className="btn-secondary">Volver</button>
                        <button onClick={() => onExportPDF(detailRef, profile.nombre_apellidos)} className="btn-action"><DownloadIcon /> Exportar a PDF</button>
                        <button onClick={onGenerateDescription} className="btn-success"><SparklesIcon />Generar Descripción</button>
                        <button onClick={onEdit} className="btn-warning">Editar</button>
                        {userRole === 'admin' && (<button onClick={onDelete} className="btn-danger"><TrashIcon /> Eliminar</button>)}
                    </div>
                </div>
            );
        };
        
        const GeneradorDescripcionModal = ({ profile, onClose, openaiApiKey, aiModel, showNotification }) => {
            const [descripcion, setDescripcion] = useState('');
            const [isGenerating, setIsGenerating] = useState(true);
            const [copyButtonText, setCopyButtonText] = useState('Copiar');

            const buildPrompt = (profile) => {
                const formatList = (items, field) => items && items.length > 0 ? items.map(item => `- ${item[field]}`).join('\n') : 'No especificadas';
                
                const responsabilidades = formatList(profile.funciones, 'funcion');
                const requisitos = profile.competencias_tecnicas ? profile.competencias_tecnicas.split('\n').filter(r => r.trim() !== '').map(r => `- ${r}`).join('\n') : 'No especificados';

                return `
                    Por favor, genera una descripción de puesto de trabajo profesional y atractiva en español para publicar en un portal de empleo. Utiliza un tono profesional y amigable.

                    Aquí está la información detallada del puesto:
                    - **Nombre de la empresa:** EGEA
                    - **Nombre del puesto:** ${profile.nombre_puesto}
                    - **Departamento / Área:** ${profile.departamento || 'No especificado'}
                    - **Ubicación:** ${profile.ubicacion || 'No especificada'}
                    - **Reporta a:** ${profile.reporta_a || 'No especificado'}
                    - **Formación mínima requerida:** ${profile.formacion || 'No especificada'}
                    - **Experiencia mínima requerida:** ${profile.experiencia || 'No especificada'}
                    - **Horario:** ${profile.horario || 'No especificado'}
                    - **Tipo de contrato:** ${profile.tipo_contrato || 'No especificado'}
                    - **Modalidad de trabajo:** ${profile.modalidad_trabajo || 'No especificada'}
                    
                    **Responsabilidades Clave:**
                    ${responsabilidades}

                    **Requisitos Clave:**
                    ${requisitos}

                    **Instrucciones para la estructura:**
                    1.  **Título del Puesto:** Usa el nombre del puesto proporcionado.
                    2.  **Introducción:** Escribe un párrafo breve y atractivo sobre la oportunidad de unirse a EGEA.
                    3.  **Responsabilidades Principales:** Crea una lista clara basada en las responsabilidades.
                    4.  **Requisitos y Cualificaciones:** Detalla lo necesario para el puesto.
                    5.  **Qué Ofrecemos:** Añade una sección sobre los beneficios.
                    6.  **Llamada a la acción:** Termina con una invitación para una aplicación.

                    El resultado final debe ser un texto coherente y bien formateado. Usa negritas (con asteriscos) para los subtítulos.
                `;
            };

            const generateDescription = useCallback(async () => {
                const prompt = buildPrompt(profile);
                setIsGenerating(true);
                setDescripcion('');

                try {
                    let text = '';
                    if (!openaiApiKey) throw new Error('La clave de API de OpenAI no está configurada.');
                    
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiApiKey}` },
                        body: JSON.stringify({ model: aiModel, messages: [{ role: 'system', content: 'Eres un asistente de RRHH experto en redactar ofertas de empleo.' }, { role: 'user', content: prompt }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    text = data.choices[0].message.content;
                    
                    text = text.replace(/\*\*(.*?)\*\*/g, '<h3 class="text-md font-bold mt-3 mb-1">$1</h3>');
                    text = text.replace(/\n/g, '<br />');
                    setDescripcion(text);

                } catch (error) {
                    setDescripcion(`Hubo un error al generar la descripción: ${error.message}`);
                    showNotification(error.message, 'error');
                } finally {
                    setIsGenerating(false);
                }
            }, [profile, openaiApiKey, aiModel, showNotification]);

            useEffect(() => {
                generateDescription();
            }, [generateDescription]);
            
            const handleCopy = () => {
                const contentEl = document.getElementById('generated-description-content');
                if (contentEl) {
                    navigator.clipboard.writeText(contentEl.innerText).then(() => {
                        setCopyButtonText('¡Copiado!');
                        setTimeout(() => setCopyButtonText('Copiar'), 2000);
                    }, (err) => {
                        showNotification('Error al copiar texto.', 'error');
                    });
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content modal-content-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Descripción de Puesto Generada con {aiModel}</h2>
                            <button onClick={onClose} className="text-2xl font-bold">&times;</button>
                        </div>
                        <div className="p-4 border rounded-md bg-gray-50 max-h-[60vh] overflow-y-auto">
                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center h-40">
                                    <LoaderIcon />
                                    <p className="mt-2 text-gray-600">Generando descripción con IA...</p>
                                </div>
                            ) : (
                                <div id="generated-description-content" dangerouslySetInnerHTML={{ __html: descripcion }}></div>
                            )}
                        </div>
                        <div className="flex justify-end gap-4 mt-4">
                            <button onClick={handleCopy} className="btn-action" disabled={isGenerating}>
                                <CopyIcon /> {copyButtonText}
                            </button>
                            <button onClick={onClose} className="btn-secondary">Cerrar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- EMPLEADOS SECTION COMPONENT ---
        const EmpleadosSection = ({ user, showNotification, onNavigate, openaiApiKey, aiModel, logActivity, userRole, predefinedOptions, profileToEdit, setProfileToEdit }) => {
            const [view, setView] = useState('list'); // 'list', 'create', 'edit', 'detail'
            const [selectedProfile, setSelectedProfile] = useState(null);
            const [jobProfiles, setJobProfiles] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [showGenerator, setShowGenerator] = useState(false);
            const [hasExistingProfile, setHasExistingProfile] = useState(false);
            
            useEffect(() => {
                if (profileToEdit) {
                    setSelectedProfile(profileToEdit);
                    setView('detail'); // Go to detail view when navigating from dashboard
                    setProfileToEdit(null); // Reset after use
                }
            }, [profileToEdit, setProfileToEdit]);

            const fetchJobData = useCallback(async () => {
                setLoading(true);
                const { data: profilesData, error: profilesError } = await supabaseClient
                    .from('job_profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (profilesError) {
                    showNotification(`Error al cargar fichas: ${profilesError.message}`, 'error');
                } else {
                    setJobProfiles(profilesData || []);
                     if (userRole === 'employee') {
                        const ownProfile = (profilesData || []).find(p => p.user_id === user.id);
                        if (ownProfile) {
                            setHasExistingProfile(true);
                            setSelectedProfile(ownProfile);
                            setView('detail');
                        } else {
                            setView('create');
                        }
                    }
                }
                setLoading(false);
            }, [showNotification, user.id, userRole]);

            useEffect(() => {
                // Only fetch on mount or if we are in the list view
                if(view === 'list') {
                   fetchJobData();
                }
            }, [fetchJobData, view]);
            
            const handleFormSave = () => {
                fetchJobData();
                setView('list');
                setSelectedProfile(null);
            };
            
            const handleDelete = async () => {
                if (!selectedProfile) return;
                 if (userRole !== 'admin') {
                    showNotification('No tienes permiso para eliminar fichas.', 'error');
                    return;
                }
                const { error } = await supabaseClient.from('job_profiles').delete().eq('id', selectedProfile.id);
                if (error) {
                    showNotification(`Error al eliminar: ${error.message}`, 'error');
                } else {
                    showNotification('Ficha eliminada con éxito.', 'success');
                    logActivity(`Eliminada ficha de ${selectedProfile.nombre_apellidos}`);
                    fetchJobData();
                    setView('list');
                    setSelectedProfile(null);
                }
                setShowDeleteConfirm(false);
            };

            const handleToggleApprove = async (profile) => {
                 if (userRole !== 'admin' && userRole !== 'management') {
                    showNotification('No tienes permiso para aprobar fichas.', 'error');
                    return;
                }
                const { error } = await supabaseClient
                    .from('job_profiles')
                    .update({ approved: !profile.approved })
                    .eq('id', profile.id);

                if (error) {
                    showNotification(`Error al actualizar estado: ${error.message}`, 'error');
                } else {
                    const actionText = !profile.approved ? `Aprobada ficha de ${profile.nombre_apellidos}` : `Desaprobada ficha de ${profile.nombre_apellidos}`;
                    showNotification('Estado actualizado.', 'success');
                    logActivity(actionText);
                    fetchJobData();
                }
            };

            const handleExportPDF = (elementRef, fileName) => {
                if (elementRef.current) {
                    html2canvas(elementRef.current, { scale: 2 }).then((canvas) => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const imgProps= pdf.getImageProperties(imgData);
                        const ratio = imgProps.height / imgProps.width;
                        let imgHeight = pdfWidth * ratio;
                        let heightLeft = imgHeight;
                        let position = 0;

                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pdfHeight;

                        while (heightLeft >= 0) {
                          position = heightLeft - imgHeight;
                          pdf.addPage();
                          pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                          heightLeft -= pdfHeight;
                        }
                        pdf.save(`${fileName || 'ficha'}.pdf`);
                        logActivity(`Exportado PDF de ${fileName}`);
                    });
                }
            };

            const filteredProfiles = jobProfiles.filter(profile =>
                (profile.nombre_apellidos && profile.nombre_apellidos.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (profile.nombre_puesto && profile.nombre_puesto.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            if (userRole === 'employee' && loading) {
                 return <div className="flex justify-center items-center h-40"><LoaderIcon /></div>;
            }

            if (view === 'create') {
                return <JobProfileForm user={user} onSave={handleFormSave} onCancel={() => setView('list')} showNotification={showNotification} predefinedOptions={predefinedOptions} logActivity={logActivity} />;
            }
            if (view === 'edit') {
                return <JobProfileForm user={user} onSave={() => { setView('detail'); fetchJobData(); }} onCancel={() => { setView('detail'); }} showNotification={showNotification} profileToEdit={selectedProfile} predefinedOptions={predefinedOptions} logActivity={logActivity} />;
            }
            if (view === 'detail') {
                return (
                    <>
                        {showDeleteConfirm && (
                            <ConfirmationModal 
                                message="¿Estás seguro de que quieres eliminar esta ficha? Esta acción no se puede deshacer."
                                onConfirm={handleDelete}
                                onCancel={() => setShowDeleteConfirm(false)}
                            />
                        )}
                        {showGenerator && (
                            <GeneradorDescripcionModal 
                                profile={selectedProfile}
                                onClose={() => setShowGenerator(false)}
                                openaiApiKey={openaiApiKey}
                                aiModel={aiModel}
                                showNotification={showNotification}
                            />
                        )}
                        <JobProfileDetail 
                            profile={selectedProfile} 
                            onBack={() => { setView('list'); setSelectedProfile(null); }}
                            onEdit={() => setView('edit')}
                            onDelete={() => setShowDeleteConfirm(true)}
                            onExportPDF={handleExportPDF}
                            onGenerateDescription={() => setShowGenerator(true)}
                            userRole={userRole}
                        />
                    </>
                );
            }

            // Vista de lista para Admin y Management
            return (
                <div>
                    <div className="phase-header">
                        <h2>Gestión de Empleados</h2>
                        <p>Busca, visualiza y añade nuevas fichas de puesto de trabajo.</p>
                    </div>
                    <div className="subsection flex flex-col md:flex-row justify-between items-center gap-4">
                        <input 
                            type="text" 
                            placeholder="Buscar por nombre o puesto..." 
                            className="form-input w-full md:flex-grow"
                            value={searchTerm}
                            onChange={e => setSearchTerm(e.target.value)}
                        />
                        <div>
                            <button onClick={() => setView('create')} className="btn-action w-full md:w-auto">Añadir Ficha</button>
                        </div>
                    </div>

                    <div className="subsection">
                        <h3>Fichas de Puesto Creadas</h3>
                        {loading ? (
                            <p>Cargando datos...</p>
                        ) : filteredProfiles.length > 0 ? (
                            <div className="overflow-x-auto">
                                <table className="min-w-full bg-white">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Puesto</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Alta</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departamento</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aprobado</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {filteredProfiles.map(profile => (
                                            <tr key={profile.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => { setSelectedProfile(profile); setView('detail'); }}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">{profile.id}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">{profile.nombre_apellidos}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">{profile.nombre_puesto}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{new Date(profile.created_at).toLocaleDateString()}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">{profile.departamento}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <label className="flex items-center" onClick={(e) => e.stopPropagation()}>
                                                        <div className="relative">
                                                            <input type="checkbox" className="sr-only" checked={profile.approved} onChange={() => handleToggleApprove(profile)} />
                                                            <div className={`block w-10 h-6 rounded-full ${profile.approved ? 'bg-blue-600' : 'bg-gray-200'}`}></div>
                                                            <div className={`dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform ${profile.approved ? 'transform translate-x-4' : ''}`}></div>
                                                        </div>
                                                    </label>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <p className="mt-4 text-gray-500">No se encontraron fichas. ¡Añade una para empezar!</p>
                        )}
                    </div>
                </div>
            );
        };

        // --- USER PROFILE & DASHBOARD COMPONENTS ---
        const ProfileDropdown = ({ user, loginTime, showNotification, onSettingsClick, onExportAll }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [showContactForm, setShowContactForm] = useState(false);
            const [contactSubject, setContactSubject] = useState('');
            const [contactMessage, setContactMessage] = useState('');
            const [elapsedTime, setElapsedTime] = useState('00:00:00');
            const dropdownRef = useRef(null);

            useEffect(() => {
                const timer = setInterval(() => {
                    const seconds = Math.floor((Date.now() - loginTime) / 1000);
                    const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
                    const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                    const s = String(seconds % 60).padStart(2, '0');
                    setElapsedTime(`${h}:${m}:${s}`);
                }, 1000);

                return () => clearInterval(timer);
            }, [loginTime]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                        setShowContactForm(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [dropdownRef]);
            
            const handleSendEmail = (e) => {
                e.preventDefault();
                const body = encodeURIComponent(contactMessage);
                const subject = encodeURIComponent(contactSubject);
                window.location.href = `mailto:hacchi.creativiza@gmail.com?subject=${subject}&body=${body}`;
                showNotification('Abriendo cliente de correo...', 'success');
                setIsOpen(false);
                setShowContactForm(false);
            };

            return (
                <div className="relative" ref={dropdownRef}>
                    <button onClick={() => setIsOpen(!isOpen)} className="p-2 rounded-full hover:bg-gray-200">
                        <UserIcon />
                    </button>
                    {isOpen && (
                        <div className="absolute right-0 mt-2 w-72 bg-white rounded-md shadow-lg z-20 border">
                            <div className="p-4">
                                {showContactForm ? (
                                    <div>
                                        <h4 className="font-bold mb-2">Enviar Consulta</h4>
                                        <form onSubmit={handleSendEmail}>
                                            <input type="text" placeholder="Asunto" className="form-input mb-2" value={contactSubject} onChange={e => setContactSubject(e.target.value)} required />
                                            <textarea placeholder="Tu mensaje..." className="form-textarea mb-2" style={{minHeight: '100px'}} value={contactMessage} onChange={e => setContactMessage(e.target.value)} required></textarea>
                                            <div className="flex justify-end gap-2">
                                                <button type="button" onClick={() => setShowContactForm(false)} className="btn-secondary text-sm">Cancelar</button>
                                                <button type="submit" className="btn-action text-sm">Enviar</button>
                                            </div>
                                        </form>
                                    </div>
                                ) : (
                                    <>
                                        <div className="border-b pb-2 mb-2">
                                            <p className="font-semibold text-sm truncate">{user.email}</p>
                                            <p className="text-xs text-gray-500">Miembro</p>
                                        </div>
                                        <div className="text-xs text-gray-500 mb-3">
                                            <p>Tiempo de conexión: {elapsedTime}</p>
                                        </div>
                                        <button onClick={onSettingsClick} className="w-full text-left text-sm p-2 rounded hover:bg-gray-100 flex items-center gap-2"><SettingsIcon /> Configuración</button>
                                        <button onClick={onExportAll} className="w-full text-left text-sm p-2 rounded hover:bg-gray-100 flex items-center gap-2"><DownloadIcon /> Exportar Todo a PDF</button>
                                        <button onClick={() => setShowContactForm(true)} className="w-full text-left text-sm p-2 rounded hover:bg-gray-100">Enviar Consulta</button>
                                        <button onClick={() => supabaseClient.auth.signOut()} className="w-full text-left text-sm p-2 rounded hover:bg-gray-100 text-red-600">Cerrar Sesión</button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        const ActivityLog = ({ log }) => {
            const timeAgo = (date) => {
                const seconds = Math.floor((new Date() - new Date(date)) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return `hace ${Math.floor(interval)} años`;
                interval = seconds / 2592000;
                if (interval > 1) return `hace ${Math.floor(interval)} meses`;
                interval = seconds / 86400;
                if (interval > 1) return `hace ${Math.floor(interval)} días`;
                interval = seconds / 3600;
                if (interval > 1) return `hace ${Math.floor(interval)} horas`;
                interval = seconds / 60;
                if (interval > 1) return `hace ${Math.floor(interval)} minutos`;
                return `hace ${Math.floor(seconds)} segundos`;
            };

            return (
                 <div className="bg-white p-4 rounded-lg shadow h-full">
                    <h3 className="font-bold mb-4">Registro de Actividad</h3>
                    <ul className="space-y-4 max-h-96 overflow-y-auto">
                        {log.map((item) => (
                            <li key={item.id} className="flex items-start">
                                <div className="flex-shrink-0 h-6 w-6 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                    <svg className="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <div>
                                    <p className="text-sm font-medium">{item.action}</p>
                                    <p className="text-xs text-gray-500">{timeAgo(item.created_at)}</p>
                                </div>
                            </li>
                        ))}
                    </ul>
                </div>
            );
        };

        const DashboardSection = ({ jobProfiles, progress, onNavigate, activityLog }) => {
            const StatCard = ({ title, value, change, isPositive }) => (
                <div className="bg-white p-4 rounded-lg shadow">
                    <p className="text-sm text-gray-500">{title}</p>
                    <p className="text-2xl font-bold my-1">{value}</p>
                    {change &&
                        <div className={`text-xs flex items-center ${isPositive ? 'text-green-500' : 'text-red-500'}`}>
                            <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                {isPositive ? <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path> : <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>}
                            </svg>
                            <span>{change}</span>
                        </div>
                    }
                </div>
            );

            const AttendanceRateChart = ({ profiles }) => {
                const [year, setYear] = useState(new Date().getFullYear());

                const activityByDate = profiles.reduce((acc, profile) => {
                    const date = new Date(profile.created_at).toISOString().slice(0, 10);
                    acc[date] = (acc[date] || 0) + 1;
                    return acc;
                }, {});

                const getColor = (count) => {
                    if (count === 0) return 'bg-gray-200';
                    if (count === 1) return 'bg-orange-300';
                    if (count <= 3) return 'bg-orange-400';
                    return 'bg-orange-500';
                };

                const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                
                let dayCells = [];
                let currentDay = new Date(year, 0, 1);
                // Pad start for the first day of the week
                const startDayOfWeek = (currentDay.getDay() + 6) % 7; // Monday = 0
                for (let i = 0; i < startDayOfWeek; i++) {
                    dayCells.push(<div key={`pad-start-${i}`} className="w-3 h-3 rounded-sm bg-transparent"></div>);
                }

                while (currentDay.getFullYear() === year) {
                    const dateStr = currentDay.toISOString().slice(0, 10);
                    const count = activityByDate[dateStr] || 0;
                    dayCells.push(
                        <div key={dateStr} className={`w-3 h-3 rounded-sm ${getColor(count)}`} title={`${dateStr}: ${count} altas`}></div>
                    );
                    currentDay.setDate(currentDay.getDate() + 1);
                }

                return (
                    <div className="bg-white p-4 rounded-lg shadow overflow-hidden">
                        <div className="flex justify-between items-center mb-4">
                             <h3 className="font-bold">Tasa de Actividad</h3>
                             <select value={year} onChange={(e) => setYear(Number(e.target.value))} className="form-input py-1 px-2 text-sm w-auto">
                                 <option>2025</option>
                                 <option>2024</option>
                                 <option>2023</option>
                             </select>
                        </div>
                        <div className="overflow-x-auto pb-2">
                             <div className="grid grid-rows-7 grid-flow-col gap-1">
                                {dayCells}
                            </div>
                        </div>
                    </div>
                );
            };
            
            const NuevasAltas = ({ profiles, onNavigate }) => (
                <div className="bg-white p-4 rounded-lg shadow">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold">Nuevas Altas</h3>
                        <button onClick={() => onNavigate('empleados')} className="text-sm text-blue-600 hover:underline">Ver todas</button>
                    </div>
                    {profiles.length > 0 ? (
                        <div className="overflow-x-auto">
                            <table className="min-w-full bg-white">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Puesto</th>
                                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departamento</th>
                                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Condición</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {profiles.slice(0, 5).map((p) => (
                                        <tr key={p.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => onNavigate('empleados', { profileToEdit: p })}>
                                            <td className="px-3 py-2 whitespace-nowrap text-sm text-blue-600 font-semibold">{p.id}</td>
                                            <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900 font-medium">{p.nombre_apellidos}</td>
                                            <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-700">{p.nombre_puesto}</td>
                                            <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-700">{p.departamento}</td>
                                            <td className="px-3 py-2 whitespace-nowrap">
                                                <span className={`text-xs font-semibold px-2 py-1 rounded-full ${p.approved ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                                                    {p.approved ? 'Aprobado' : 'Pendiente'}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <p className="mt-4 text-gray-500">No hay nuevas altas.</p>
                    )}
                </div>
            );

             const totalProfiles = jobProfiles.length;
            const approvedProfiles = jobProfiles.filter(p => p.approved).length;

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard title="Fichas Totales" value={totalProfiles} />
                        <StatCard title="Fichas Aprobadas" value={approvedProfiles} />
                        <StatCard title="Progreso del Estudio" value={`${Math.round(progress)}%`} />
                        <StatCard title="Tasa de Aprobación" value={`${totalProfiles > 0 ? Math.round((approvedProfiles / totalProfiles) * 100) : 0}%`} />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2">
                             <NuevasAltas profiles={jobProfiles} onNavigate={onNavigate} />
                        </div>
                        <div className="lg:col-span-1">
                            <ActivityLog log={activityLog} />
                        </div>
                    </div>
                     <AttendanceRateChart profiles={jobProfiles} />
                </div>
            );
        };

        const OrgChartSection = ({ profiles, showNotification, onEditProfile }) => {
            const [orgData, setOrgData] = useState(null);

            useEffect(() => {
                if (profiles && profiles.length > 0) {
                    const nodes = {};
                    profiles.forEach(p => {
                        nodes[p.nombre_puesto] = {
                            id: p.id,
                            name: p.nombre_apellidos,
                            role: p.nombre_puesto,
                            department: p.departamento,
                            children: []
                        };
                    });

                    const rootNodes = [];
                    profiles.forEach(p => {
                        if (p.reporta_a && nodes[p.reporta_a]) {
                            // Prevent duplicates
                            if (!nodes[p.reporta_a].children.some(child => child.role === p.nombre_puesto)) {
                                nodes[p.reporta_a].children.push(nodes[p.nombre_puesto]);
                            }
                        } else {
                            // Prevent duplicates
                             if (!rootNodes.some(node => node.role === p.nombre_puesto)) {
                                rootNodes.push(nodes[p.nombre_puesto]);
                            }
                        }
                    });

                    // Group root nodes by department for better visualization
                    const groupedByDept = rootNodes.reduce((acc, node) => {
                        const dept = node.department || 'Sin Departamento';
                        if (!acc[dept]) {
                            acc[dept] = { name: dept, role: dept, children: [] };
                        }
                        acc[dept].children.push(node);
                        return acc;
                    }, {});

                    const finalData = {
                        name: 'EGEA',
                        role: 'Dirección General',
                        children: Object.values(groupedByDept)
                    };
                    
                    setOrgData(finalData);
                }
            }, [profiles]);

            const renderNode = (node) => (
                <li key={node.id || node.role}>
                    <div className="org-chart-node">
                        <p className="role">{node.role}</p>
                        <p className="name">{node.name}</p>
                         {node.id && (
                            <button 
                                onClick={() => onEditProfile(node.id)}
                                title="Editar esta ficha"
                                className="edit-org-btn"
                            >
                               ✎
                            </button>
                        )}
                    </div>
                    {node.children && node.children.length > 0 && (
                        <ul>
                            {node.children.map(child => renderNode(child))}
                        </ul>
                    )}
                </li>
            );

            return (
                <div className="subsection">
                     <h2 className="text-xl font-bold mb-4">Organigrama de la Empresa</h2>
                     <p className="mb-6 text-sm text-gray-500">Esta es una representación visual de la estructura jerárquica basada en las fichas de puesto. Puedes hacer clic en el lápiz (✎) para editar una ficha directamente.</p>
                     <div className="org-chart-container p-4 bg-gray-50 rounded-lg">
                        {orgData ? (
                            <ul className="org-chart">
                                {renderNode(orgData)}
                            </ul>
                        ) : (
                            <p>No hay suficientes datos para generar el organigrama. Asegúrate de que las fichas de puesto tengan definidos los campos "Puesto" y "Reporta a".</p>
                        )}
                    </div>
                </div>
            );
        };

        // --- MASTER COMPONENT: EstudioApp ---
        const EstudioApp = ({ user }) => {
            const [userRole, setUserRole] = useState('employee'); // Default role
            const [taskStates, setTaskStates] = useState({});
            const [editingTaskId, setEditingTaskId] = useState(null);
            const [currentView, setCurrentView] = useState('dashboard');
            const [isRecording, setIsRecording] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [activeTaskId, setActiveTaskId] = useState(null);
            const [notification, setNotification] = useState({ message: '', type: '', visible: false });
            const [showSettings, setShowSettings] = useState(false);
            const [openaiApiKey, setOpenaiApiKey] = useState('');
            const [aiModel, setAiModel] = useState('gpt-3.5-turbo');
            const recognitionRef = useRef(null);
            const [loginTime] = useState(Date.now());
            const [activityLog, setActivityLog] = useState([]);
            const [jobProfiles, setJobProfiles] = useState([]);
            const [profileToEdit, setProfileToEdit] = useState(null); // Used for navigation
            const [navMenuOpen, setNavMenuOpen] = useState(false);

            // Predefined options for forms
            const [predefinedOptions, setPredefinedOptions] = useState({
                puestos: [],
                departamentos: [],
                reporta_a: [],
                tipos_contrato: ['Indefinido', 'Temporal', 'Obra y Servicio', 'Formación', 'Prácticas']
            });

            // Fetch user role
            useEffect(() => {
                const fetchUserRole = async () => {
                    const { data, error } = await supabaseClient
                        .from('profiles')
                        .select('role')
                        .eq('id', user.id)
                        .single();
                    if (!error && data) {
                        setUserRole(data.role);
                    }
                };
                fetchUserRole();
            }, [user.id]);
            
            // Fetch all required data
            const fetchData = useCallback(async () => {
                const { data: profilesData, error: profilesError } = await supabaseClient.from('job_profiles').select('*');
                if (profilesError) showNotification(`Error al cargar perfiles: ${profilesError.message}`, 'error');
                else {
                    setJobProfiles(profilesData || []);
                    setPredefinedOptions(prev => ({
                        ...prev,
                        puestos: [...new Set(profilesData.map(p => p.nombre_puesto).filter(Boolean))],
                        departamentos: [...new Set(profilesData.map(p => p.departamento).filter(Boolean))],
                        reporta_a: [...new Set(profilesData.map(p => p.nombre_puesto).filter(Boolean))]
                    }));
                }

                const { data: tasksData, error: tasksError } = await supabaseClient.from('task_states').select('*');
                if (tasksError) showNotification(`Error al cargar tareas: ${tasksError.message}`, 'error');
                else {
                    const initialStates = allTaskIds.reduce((acc, taskId) => {
                        const savedState = (tasksData || []).find(t => t.task_id === taskId);
                        acc[taskId] = savedState || { task_id: taskId, is_completed: false, notes: '' };
                        return acc;
                    }, {});
                    setTaskStates(initialStates);
                }

                const { data: settingsData, error: settingsError } = await supabaseClient.from('settings').select('*').eq('id', 1).single();
                if (!settingsError && settingsData) {
                    setOpenaiApiKey(settingsData.openai_api_key || '');
                    setAiModel(settingsData.ai_model || 'gpt-3.5-turbo');
                }

                const { data: logData, error: logError } = await supabaseClient.from('activity_log').select('*').order('created_at', { ascending: false }).limit(20);
                if (!logError) setActivityLog(logData || []);

            }, []);

            useEffect(() => {
                fetchData();
            }, [fetchData]);
            
             const logActivity = useCallback(async (action) => {
                const { error } = await supabaseClient.from('activity_log').insert({ user_email: user.email, action });
                if (error) console.error("Error logging activity:", error);
                else {
                    // Refresh log
                    const { data: logData, error: logError } = await supabaseClient.from('activity_log').select('*').order('created_at', { ascending: false }).limit(10);
                    if (!logError) setActivityLog(logData);
                }
            }, [user.email]);

            const showNotification = (message, type = 'success') => {
                setNotification({ message, type, visible: true });
                setTimeout(() => setNotification({ message: '', type: '', visible: false }), 4000);
            };

            const handleUpdateTaskState = async (taskId, updates) => {
                const updatedState = { ...taskStates[taskId], ...updates };
                setTaskStates(prev => ({ ...prev, [taskId]: updatedState }));
                
                const { error } = await supabaseClient
                    .from('task_states')
                    .upsert({ task_id: taskId, ...updates }, { onConflict: 'task_id' });
                
                if (error) showNotification(`Error al guardar: ${error.message}`, 'error');
            };

            // Setup Speech Recognition
            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.lang = 'es-ES';
                    recognitionRef.current.interimResults = true;

                    recognitionRef.current.onresult = (event) => {
                        let interimTranscript = '';
                        let finalTranscript = '';
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                finalTranscript += event.results[i][0].transcript;
                            } else {
                                interimTranscript += event.results[i][0].transcript;
                            }
                        }
                        if (finalTranscript && activeTaskId) {
                             const currentNotes = taskStates[activeTaskId]?.notes || '';
                             const summarySeparator = '--- Resumen IA ---';
                             const hasSummary = currentNotes.includes(summarySeparator);
                             const mainNotes = hasSummary ? currentNotes.split(summarySeparator)[0].trim() : currentNotes;
                             const summaryText = hasSummary ? `\n\n${summarySeparator}\n${currentNotes.split(summarySeparator)[1].trim()}` : '';
                             const newNotes = (mainNotes ? mainNotes + ' ' : '') + finalTranscript.trim() + '.';
                             handleUpdateTaskState(activeTaskId, { notes: newNotes + summaryText });
                        }
                    };
                }
            }, [taskStates, activeTaskId]);

            const handleRecord = (taskId) => {
                if (!recognitionRef.current) {
                    showNotification('El reconocimiento de voz no es compatible con este navegador.', 'error');
                    return;
                }
                if (isRecording) {
                    recognitionRef.current.stop();
                    setIsRecording(false);
                    setActiveTaskId(null);
                } else {
                    setActiveTaskId(taskId);
                    setIsRecording(true);
                    recognitionRef.current.start();
                }
            };

            const handleSummarize = async (taskId) => {
                if (!openaiApiKey) {
                    showNotification('Por favor, configura tu clave de API de OpenAI en los ajustes.', 'error');
                    return;
                }
                setIsProcessing(true);
                setActiveTaskId(taskId);
                const currentNotes = taskStates[taskId]?.notes || '';
                const summarySeparator = '--- Resumen IA ---';
                const mainNotes = currentNotes.includes(summarySeparator) ? currentNotes.split(summarySeparator)[0] : currentNotes;

                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiApiKey}` },
                        body: JSON.stringify({ model: aiModel, messages: [ { role: 'system', content: 'Eres un asistente experto en resumir notas de reuniones y análisis organizacionales. Resume los siguientes puntos en un párrafo conciso y claro.' }, { role: 'user', content: mainNotes } ] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    const summary = data.choices[0].message.content;
                    const newNotes = `${mainNotes}\n\n${summarySeparator}\n${summary}`;
                    handleUpdateTaskState(taskId, { notes: newNotes });
                    showNotification('Resumen generado con éxito.', 'success');

                } catch (error) {
                    showNotification(`Error al generar resumen: ${error.message}`, 'error');
                } finally {
                    setIsProcessing(false);
                    setActiveTaskId(null);
                }
            };
            
            const handleSaveSettings = async () => {
                const { error } = await supabaseClient.from('settings').upsert({ id: 1, openai_api_key: openaiApiKey, ai_model: aiModel }, { onConflict: 'id' });
                if (error) {
                    showNotification('Error al guardar la configuración: ' + error.message, 'error');
                } else {
                    showNotification('Configuración guardada con éxito.', 'success');
                    setShowSettings(false);
                }
            };
            
            const handleNavigate = (view, params = {}) => {
                if (params.profileToEdit) {
                    setProfileToEdit(params.profileToEdit);
                }
                setCurrentView(view);
                setNavMenuOpen(false); // Close mobile menu on navigation
            };

            const totalTasks = allTaskIds.length;
            const completedTasks = Object.values(taskStates).filter(t => t.is_completed).length;
            const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
            
            const navItems = [
                { id: 'dashboard', title: 'Visión General' },
                { id: 'empleados', title: 'Empleados', roles: ['admin', 'management'] },
                { id: 'orgchart', title: 'Organigrama', roles: ['admin', 'management'] },
                ...studyData.filter(p => p.id !== 'dashboard').map(({ id, title }) => ({ id, title, roles: ['admin'] }))
            ];
            
            const visibleNavItems = navItems.filter(item => !item.roles || item.roles.includes(userRole));


            return (
                <div className="container">
                    {notification.visible && <div className={`notification ${notification.type}`}>{notification.message}</div>}
                    
                    {showSettings && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h2 className="text-xl font-bold mb-4">Configuración</h2>
                                <label className="form-label">Clave API de OpenAI</label>
                                <input type="password" value={openaiApiKey} onChange={(e) => setOpenaiApiKey(e.target.value)} className="form-input" placeholder="sk-..." />
                                <p className="text-xs text-gray-500 mt-1">Tu clave se guarda de forma segura y no se comparte.</p>
                                <label className="form-label">Modelo de IA</label>
                                <select value={aiModel} onChange={(e) => setAiModel(e.target.value)} className="form-select">
                                    <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                </select>
                                <div className="mt-6 flex justify-end gap-2">
                                    <button onClick={() => setShowSettings(false)} className="btn-secondary">Cancelar</button>
                                    <button onClick={handleSaveSettings} className="btn-action">Guardar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <header className="header">
                        <div className="header-title">
                            <h1>Estudio Organizativo de EGEA</h1>
                            <p>Plataforma para el análisis y la mejora estructural.</p>
                        </div>
                         <div className="header-actions">
                             <div className="relative">
                                <div className="w-full bg-gray-200 rounded-full h-2.5">
                                    <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${progress}%` }}></div>
                                </div>
                                <span className="absolute -top-5 right-0 text-xs font-semibold text-blue-800">{Math.round(progress)}%</span>
                            </div>
                            <ProfileDropdown user={user} loginTime={loginTime} showNotification={showNotification} onSettingsClick={() => setShowSettings(true)} />
                             <div className="md:hidden">
                                 <button onClick={() => setNavMenuOpen(!navMenuOpen)} className="p-2">
                                     {navMenuOpen ? <XIcon /> : <MenuIcon />}
                                 </button>
                             </div>
                        </div>
                    </header>

                    <nav className={`navigation ${navMenuOpen ? '!flex flex-col items-stretch' : ''}`}>
                        {visibleNavItems.map(item => (
                            <button key={item.id} onClick={() => handleNavigate(item.id)} className={`nav-btn ${currentView === item.id ? 'active' : ''}`}>
                                {item.title}
                            </button>
                        ))}
                    </nav>

                    <main>
                       {visibleNavItems.map(item => (
                           <section key={item.id} id={item.id} className={`content-section ${currentView === item.id ? 'active' : ''}`}>
                               {/* Render content based on view */}
                           </section>
                       ))}
                        
                        <div className={currentView === 'dashboard' ? 'content-section active' : 'content-section'}>
                            <DashboardSection jobProfiles={jobProfiles} progress={progress} onNavigate={handleNavigate} activityLog={activityLog} />
                        </div>

                         <div className={currentView === 'empleados' ? 'content-section active' : 'content-section'}>
                            <EmpleadosSection user={user} showNotification={showNotification} onNavigate={handleNavigate} openaiApiKey={openaiApiKey} aiModel={aiModel} logActivity={logActivity} userRole={userRole} predefinedOptions={predefinedOptions} profileToEdit={profileToEdit} setProfileToEdit={setProfileToEdit} />
                        </div>
                        
                        <div className={currentView === 'orgchart' ? 'content-section active' : 'content-section'}>
                            <OrgChartSection 
                                profiles={jobProfiles.filter(p => p.approved)} 
                                showNotification={showNotification}
                                onEditProfile={(id) => {
                                    const profile = jobProfiles.find(p => p.id === id);
                                    if(profile) handleNavigate('empleados', { profileToEdit: profile });
                                }}
                            />
                        </div>

                        {studyData.filter(p => p.sections).map(phase => (
                            <div key={phase.id} className={currentView === phase.id ? 'content-section active' : 'content-section'}>
                                {phase.sections.map((section, index) => (
                                    <div key={index}>
                                        {section.title && (
                                            <div className="phase-header">
                                                <h2>{section.title}</h2>
                                                {section.description && <p>{section.description}</p>}
                                            </div>
                                        )}
                                        {section.tasks && (
                                            <div className="subsection">
                                                <h3>{section.subtitle}</h3>
                                                <ul className="checklist">
                                                    {section.tasks.map((task) => (
                                                        <TaskItem
                                                            key={task}
                                                            taskId={task}
                                                            taskState={taskStates[task] || { is_completed: false, notes: '' }}
                                                            onToggle={handleUpdateTaskState}
                                                            onNoteChange={handleUpdateTaskState}
                                                            isEditing={editingTaskId === task}
                                                            onEditClick={(taskId) => setEditingTaskId(editingTaskId === taskId ? null : taskId)}
                                                            onRecord={{ handle: handleRecord, isRecording, isProcessing, activeTaskId }}
                                                            onSummarize={handleSummarize}
                                                        />
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ))}

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>